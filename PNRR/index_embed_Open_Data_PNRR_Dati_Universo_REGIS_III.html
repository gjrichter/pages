<!DOCTYPE html>
<html>

<!-- **********************************************************************

ixmaps map embed html

$Comment: ixmaps map template; embedded version
$Source : index_only_map_embed.html,v $

$InitialAuthor: guenter richter $
$InitialDate: 2023/04/22 $
$Author: guenter richter $
$Id:index_embed_Open_Data_PNRR_Dati_Universo_REGIS_III.html 1 2023-04-22 00:00:00Z Guenter Richter $

licensed under CC-BY
$Log:index_only_map_embed.html,v $

********************************************************************** -->

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="ixmaps embed example">
	<meta name="author" content="guenter richter">
	<link rel="shortcut icon" href="https://gjrichter.github.io/ixmaps/ui/resources/images/ixmaps_logo.png">

	<title>iXMaps embed</title>

</head>

<body style='text-align:center;background:#F7F6EF'>

	<!--========================================================================= -->

	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
	<script src="https://gjrichter.github.io/ixmaps/ui/js/htmlgui_api.js"></script>
	<script src="https://gjrichter.github.io/data.js/data.js"></script>
	<script src="./facet.js"></script>

	<!--========================================================================= -->

	<script type="text/javascript" charset="utf-8">
		
		/**
		 ** ************************************
		 ** define the ixmaps themes and project
		 ** ************************************
		 **/
		
		ixmaps.tmp = ixmaps.tmp || {};

		var __filter = "";
		var __lat = 41.86956082699455;
		var __lon = 13.150634765625002;
		var __zoom = 6;	 

		/**
		 ** strings used by the map 	
		 **/

		attribution =
			"powered by <a href=\"http://ixmaps.com\" target=\"_blank\">iXMaps</a>";

		/**
		 ** get query params and adapt theme and project definitions 	
		 **/
		
		const params = new Proxy(new URLSearchParams(window.location.search), {
		  get: (searchParams, prop) => searchParams.get(prop),
		});
		
		if (params.filter){
			__filter = params.filter;
		};
		
		if (params.view){
			var latlonA = params.view.split('[')[1].split(']')[0].split(',');
			__lat = latlonA[0];
			__lon = latlonA[1];
			__zoom = parseInt(params.view.split(',')[2]);
			//setTimeout("ixmaps.setView(null,"+params.view+")",1000);
		};

		/**
		 ** define layer with reference shapes (comuni, province, regioni ) 
		 **/
		
		/* 1. load centroids of 2011, by curtesy of Andrea Borruso */
		var __georef_urban =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					url: "https://raw.githubusercontent.com/aborruso/centroidiurbanfabric/master/output/ElencoUnitaAmministrative2011.geojson",
					type: "geojson"
				})
				.binding({
					id: "PRO_COM",
					position: "geometry"
				})
				.type("FEATURES|NOLEGEND")
				.style({
					colorscheme: ["none"],
					linecolor: "none",
					linewidth: "1",
					scale: "0.1"
				})
			);

		/* 2. load last istat data (2022), for changes since 2011 */
		var __georef =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					url: "https://s3.eu-central-1.amazonaws.com/maps.ixmaps.com/Istat/comuni_2022/Com01012022_s_WGS84.topojson.gz",
					type: "topojson"
				})
				.binding({
					id: "PRO_COM",
					position: "geometry"
				})
				.type("FEATURES|NOLEGEND")
				.style({
					colorscheme: ["none"],
					linecolor: "none",
					linewidth: "1",
					sizefield: "Shape_Area"
				})
			);


		var __georef_prov =
			ixmaps.layer("ITALIA_Province_2022", layer => layer
				.data({
					url: "https://s3.eu-central-1.amazonaws.com/maps.ixmaps.com/Istat/province_2022/Prov01012022_g_WGS84.topojson.gz",
					type: "topojson"
				})
				.binding({
					id: "COD_PROV",
					position: "geometry"
				})
				.type("FEATURES|NOLEGEND")
				.style({
					colorscheme: ["none"],
					linecolor: "black",
					linewidth: "0.3",
					sizefield: "Shape_Area"
				})
			);

		var __georef_reg =
			ixmaps.layer("ITALIA_Regioni_2022", layer => layer
				.data({
					url: "https://s3.eu-central-1.amazonaws.com/maps.ixmaps.com/Istat/regioni_2022/Reg01012022_s_WGS84.topojson.gz",
					type: "topojson"
				})
				.binding({
					id: "COD_REG",
					position: "geometry"
				})
				.type("FEATURES|NOLEGEND")
				.style({
					colorscheme: ["rgba(255,255,255,0.5)"],
					linecolor: "black",
					linewidth: "1",
					sizefield: "Shape_Area"
				})
			);

		/**
		 ** visualizzation themes 
		 **/
		
		var __CUP_PNRR_choropleth =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					url: "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/PNRR/PNRR_Localizzazione-Universo_REGIS_plus.csv.gz",
					type: "csv",
					name: "pnrr_data"
				})
				.binding({
					position: "PROCOM",
					value: "missione",
					size: "importo",
					title: "Descrizione Comune"
				})
				.filter(__filter)		 
				.type("CHOROPLETH|DOMINANT|CATEGORICAL|ORDER|AGGREGATE|SUM|DOPACITYMAX|NOLEGEND")
				.style({
					values: ["M1", "M2", "M3", "M4", "M5", "M6"],
					label: ["M1 - Digitalizz., innov., competi., cultura e turismo",
						"M2 - Rivoluzione verde e trans. eco.",
						"M3 - Infrastrutture per una mobilità sostenibile",
						"M4 - Istruzione e ricerca",
						"M5 - Inclusione e coesione",
						"M6 - Salute"
					],
					colorscheme: [
						"#5BBBEB",
						"#92C151",
						"#EA425B",
						"#F49E4B",
						"#B671DC",
						"#FACB49"
					],
					showdata: "true",
					units: "€",
					dopacitypow: "3",
					dopacityscale: "0.5",
					chartupper: "1:2000000",
					aggregationfield: "PROCOM",
					name: "choropleth"
				})
				.meta({
					title: "<b>Open CUP : Focus PNRR</b>",
					splash: "scaricando dati ..."
				})
			);

		var __CUP_PNRR_chart =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					url: "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/PNRR/PNRR_Localizzazione-Universo_REGIS_plus.csv.gz",
					type: "csv",
					name: "pnrr_data"
				})
				.binding({
					position: "PROCOM",
					value: "missione",
					size: "importo",
					title: "Descrizione Comune"
				})
				.filter(__filter)		 
				.type("CHART|SYMBOL|GLOW|SEQUENCE|STAR|SORT|DOWN|GLOW|CATEGORICAL|ORDER|AGGREGATE|SUM|VALUES|INLINETEXT|COMPACTLEGEND")
				.style({
					values: ["M1", "M2", "M3", "M4", "M5", "M6"],
					label: ["M1 - Digitalizz., innov., competi., cultura e turismo",
						"M2 - Rivoluzione verde e trans. eco.",
						"M3 - Infrastrutture per una mobilità sostenibile",
						"M4 - Istruzione e ricerca",
						"M5 - Inclusione e coesione",
						"M6 - Salute"
					],
					colorscheme: [
						"#5BBBEB",
						"#92C151",
						"#EA425B",
						"#F49E4B",
						"#B671DC",
						"#FACB49"
					],
					showdata: "true",
					units: "€",
					scale: "5",
					aggregationscale: [
						"1:1", "PROCOM",
						"1:10000000", "Descrizione Provincia"
					],
					xxglowupper: "1:1000000",
					valueupper: "1:1000000",
					chartupper: "1:2000000",
					chartlower: "1:100000",
					name: "chart"
				})
				.meta({
					title: "<b>PNRR - Universo REGIS</b>",
					description: "<b>nota bene:</b> Il livello comunale include solo i progetti direttamente associati ad un comune",
					splash: "scaricando dati ..."
				})
			);

		var __CUP_PNRR_chart_prov =
			ixmaps.layer("ITALIA_Province_2022", layer => layer
				.data({
					url: "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/PNRR/PNRR_Localizzazione-Universo_REGIS_plus.csv.gz",
					type: "csv",
					name: "pnrr_data"
				})
				.binding({
					position: "Provincia",
					value: "missione",
					size: "importo",
					title: "Descrizione Comune"
				})
				.filter(__filter)		 
				.type("CHART|SYMBOL|GLOW|SEQUENCE|STAR|SORT|DOWN|GLOW|CATEGORICAL|ORDER|AGGREGATE|SUM|INLINETEXT|COMPACTLEGEND")
				.style({
					values: ["M1", "M2", "M3", "M4", "M5", "M6"],
					label: ["M1 - Digitalizz., innov., competi., cultura e turismo",
						"M2 - Rivoluzione verde e trans. eco.",
						"M3 - Infrastrutture per una mobilità sostenibile",
						"M4 - Istruzione e ricerca",
						"M5 - Inclusione e coesione",
						"M6 - Salute"
					],
					colorscheme: [
						"#5BBBEB",
						"#92C151",
						"#EA425B",
						"#F49E4B",
						"#B671DC",
						"#FACB49"
					],
					showdata: "true",
					units: "€",
					scale: "3",
					chartupper: "1:5000000",
					chartlower: "1:2000000",
					name: "chart_prov"
				})
				.meta({
					title: "<b>PNRR - Universo REGIS</b>",
					description: "<b>nota bene:</b> L’aggregazione a livello provinciale include anche i progetti per tutti i comuni, ma non i progetto dell'ambito nazionale.",
					splash: "scaricando dati ..."
				})
			);
		
		
		var __CUP_PNRR_chart_reg =
			ixmaps.layer("ITALIA_Regioni_2022", layer => layer
				.data({
					url: "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/PNRR/PNRR_Localizzazione-Universo_REGIS_plus.csv.gz",
					type: "csv",
					name: "pnrr_data"
				})
				.binding({
					position: "Regione",
					value: "missione",
					size: "importo",
					title: "Descrizione Comune"
				})
				.filter(__filter)		 
				.type("CHART|SYMBOL|SEQUENCE|STAR|SORT|DOWN|CATEGORICAL|ORDER|AGGREGATE|SUM|INLINETEXT|COMPACTLEGEND")
				.style({
					values: ["M1", "M2", "M3", "M4", "M5", "M6"],
					label: ["M1 - Digitalizz., innov., competi., cultura e turismo",
						"M2 - Rivoluzione verde e trans. eco.",
						"M3 - Infrastrutture per una mobilità sostenibile",
						"M4 - Istruzione e ricerca",
						"M5 - Inclusione e coesione",
						"M6 - Salute"
					],
					colorscheme: [
						"#5BBBEB",
						"#92C151",
						"#EA425B",
						"#F49E4B",
						"#B671DC",
						"#FACB49"
					],
					showdata: "true",
					units: "€",
					scale: "5",
					xxglowupper: "1:1000000",
					chartlower: "1:5000000",
					name: "chart_reg"
				})
				.meta({
					title: "<b>PNRR - Universo REGIS</b>",
					description: "<b>nota bene:</b> L’aggregazione a livello regionale include i progetti per tutti i comuni e dell’ambito nazionale.",
					splash: "scaricando dati ..."
				})
			);
		
		
		var __CUP_PNRR_PROJECTS =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					url: "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/PNRR/PNRR_Localizzazione-Universo_REGIS_plus.csv.gz",
					type: "csv",
					name: "pnrr_data"
				})
				.binding({
					position: "PROCOM",
					value: "missione",
					title: "Descrizione Comune"
				})
				.filter(__filter)		 
				.type("CHART|SYMBOL|VALUES|SIZEP10|INLINETEXT|MULTIQUAD|SORT|CATEGORICAL|SUM|BOX|TITLE|COMPACTLEGEND")
				.style({
					values: ["M1", "M2", "M3", "M4", "M5", "M6"],
					label: ["M1 - Digitalizz., innov., competi., cultura e turismo",
						"M2 - Rivoluzione verde e trans. eco.",
						"M3 - Infrastrutture per una mobilità sostenibile",
						"M4 - Istruzione e ricerca",
						"M5 - Inclusione e coesione",
						"M6 - Salute"
					],
					colorscheme: [
						"#5BBBEB",
						"#92C151",
						"#EA425B",
						"#F49E4B",
						"#B671DC",
						"#FACB49"
					],
					showdata: "true",
					valuefield: "importo",
					sizefield: "importo",
					units: "€",
					gridx: "20",
					scale: "0.75",
					normalsizevalue: "100000",
					linecolor: "white",
					linewidth: "0.1",
					rangescale: "1.1",
					valuescale: "0.35",
					boxopacity: "0.5",
					boxmargin: "2",
					textscale: "2",
					chartupper: "1:100000",
					name: "details"
				})
				.meta({
					title: "<b>Open CUP : Focus PNRR</b><br>i singoli progetti",
					splash: "scaricando dati ..."
				})
			);

		var __CUP_PNRR_PROJECTS_SUM =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					url: "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/PNRR/PNRR_Localizzazione-Universo_REGIS_plus.csv.gz",
					type: "csv",
					name: "pnrr_data"
				})
				.binding({
					position: "PROCOM",
					value: "missione",
					size: "importo",
					title: "Descrizione Comune"
				})
				.filter(__filter)		 
				.type("CHART|BAR|HORZ|SIZEP4|SORT|VALUES|CATEGORICAL|AGGREGATE|SUM|BOX|TITLE|COMPACTLEGEND")
				.style({
					values: ["M1", "M2", "M3", "M4", "M5", "M6"],
					label: ["M1 - Digitalizz., innov., competi., cultura e turismo",
						"M2 - Rivoluzione verde e trans. eco.",
						"M3 - Infrastrutture per una mobilità sostenibile",
						"M4 - Istruzione e ricerca",
						"M5 - Inclusione e coesione",
						"M6 - Salute"
					],
					colorscheme: [
						"#5BBBEB",
						"#92C151",
						"#EA425B",
						"#F49E4B",
						"#B671DC",
						"#FACB49"
					],
					showdata: "true",
					gridx: "10",
					scale: "1",
					rangescale: "0.2",
					valuescale: "0.8",
					textscale: "1.3",
					units: "€",
					normalsizevalue: "100000",
					boxopacity: "0.5",
					boxmargin: "5",
					chartupper: "1:100000",
					name: "details_sum"
				})
				.meta({
					title: "<b>Open CUP : Focus PNRR</b>",
					splash: "scaricando dati ..."
				})
			);

		var __CUP_PNRR_PROVINCE_SUM =
			ixmaps.layer("ITALIA_Province_2022", layer => layer
				.data({
					url: "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/PNRR/PNRR_Localizzazione-Universo_REGIS_plus.csv.gz",
					type: "csv",
					name: "pnrr_data"
				})
				.binding({
					position: "Provincia",
					value: "$item$",
					size: "importo",
					title: "Descrizione Comune"
				})
				.filter(__filter)		 
				.type("RECT|CHART|SYMBOLS|SIZEP4|TEXTONLY|AGGREGATE|VALUES|SUM|NOLEGEND")
				.style({
					colorscheme: ["white"],
					symbols: ["label"],
					units: "€",
					showdata: "true",
					scale: "5",
					rangescale: "0.2",
					textcolor: "#aaaaaa",
					textscale: "1.3",
					titlefield: "Descrizione Provincia",
					chartupper: "1:3000000",
					chartlower: "1:250000",
					valuescale: "0.8",
					aggregationfield: "Provincia",
					name: "province_sum"
				})
				.meta({
					title: "<b>Open CUP : Focus PNRR</b>",
					splash: "scaricando dati ..."
				})
			);
		
		var __CUP_PNRR_REGIONI_SUM =
			ixmaps.layer("ITALIA_Regioni_2022", layer => layer
				.data({
					url: "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/PNRR/PNRR_Localizzazione-Universo_REGIS_plus.csv.gz",
					type: "csv",
					name: "pnrr_data"
				})
				.binding({
					position: "Regione",
					value: "$item$",
					size: "importo",
					title: "Descrizione Regione"
				})
				.filter(__filter)		 
				.type("RECT|CHART|SYMBOLS|SIZEP4|TEXTONLY|AGGREGATE|VALUES|SUM|NOLEGEND")
				.style({
					colorscheme: ["white"],
					symbols: ["label"],
					units: "€",
					showdata: "true",
					scale: "7",
					align: "baseline",
					rangescale: "0.2",
					textcolor: "#888888",
					textscale: "1.3",
					titlefield: "Descrizione Regione",
					chartlower: "1:3000000",
					valuescale: "0.8",
					name: "regioni_sum"
				})
				.meta({
					title: "<b>PNRR - Universo REGIS</b>",
					snippet: "include i progetti al livello regionale (tutti comuni) e del Ambito Nazionale",
					splash: "scaricando dati ..."
				})
			);
		
		
		
		/**
		 **
		 ** create the interactive map an append it to the document 
		 **
		 **/

		document.activeElement.appendChild(

			ixmaps.embed("mymap", {
					mapService: "leaflet",
					mapType: "OpenStreetMap - FR",
					map: "../../maps/svg/maps/generic/mercator.svg",
					mode: "pan",
					width: "100%",
					width: (window.innerWidth - 360) + "px",
					height: (window.innerHeight * 0.95) + "px",
					legend: "true",
					tools: "true",
					align: "right",
					search: "Italy"
				},
				map => map
				.view([__lat,__lon],__zoom)	 
				.options({
					objectscaling: "dynamic",
					normalSizeScale: "27033",
					dynamicScalePow: "3",
					flushChartDraw: "1000000",
					basemapopacity: "0.1",
					panhidden: "false"
				})
				.local("aggregated", "")
				.require("https://raw.githubusercontent.com/gjrichter/pages/main/PNRR/item_simple.js")
				.attribution(attribution)

				// -----------------------------		 
				// the data visualization layer 
				// -----------------------------

				.layer(__georef_urban)
				.layer(__georef)
				.layer(__georef_prov)
				.layer(__georef_reg)
				.layer(__CUP_PNRR_choropleth)
				.layer(__CUP_PNRR_chart)
				.layer(__CUP_PNRR_chart_reg)
				.layer(__CUP_PNRR_chart_prov)
				.layer(__CUP_PNRR_PROJECTS)
				.layer(__CUP_PNRR_PROVINCE_SUM)
				.layer(__CUP_PNRR_REGIONI_SUM)
			)
		);

	</script>

	<!-- ------------------------------------- -->
	<!--                                       -->
	<!-- s i d e b a r                         -->
	<!--                                       -->
	<!-- ------------------------------------- -->
	
	<!-- ------------------------------------- -->
	<!-- user buttons to change the map charts -->
	<!-- ------------------------------------- -->

	<div style="position:absolute;top:1em;right:2em">

		<script>
			var getThemeNames = function() {
				var themesA = ixmaps.getThemes();
				var namesA = [];
				for (var i in themesA) {
					namesA.push(themesA[i].szId);
				}
				alert(namesA);
			}

			var sizeCharts = function(nFactor) {
				ixmaps.changeThemeStyle(null, 'chart', 'scale:' + nFactor, 'factor');
				ixmaps.changeThemeStyle(null, 'chart_prov', 'scale:' + nFactor, 'factor');
				ixmaps.changeThemeStyle(null, 'chart_reg', 'scale:' + nFactor, 'factor');
				ixmaps.changeThemeStyle(null, 'details', 'scale:' + nFactor, 'factor');
				ixmaps.changeThemeStyle(null, 'province_sum', 'scale:' + nFactor, 'factor');
				ixmaps.changeThemeStyle(null, 'regioni_sum', 'scale:' + nFactor, 'factor');
			}
			var heightCharts = function(nFactor) {
				ixmaps.changeThemeStyle(null, 'curves', 'rangescale:' + nFactor, 'factor');
			}
			var opacityCharts = function(nFactor) {
				ixmaps.changeThemeStyle(null, 'curves', 'fillopacity:' + nFactor, 'factor');
			}
			var filterCharts = function(szFilter) {
				ixmaps.changeThemeStyle(null, 'symbols', 'filter:' + szFilter, 'set');
				ixmaps.changeThemeStyle(null, 'curves', 'filter:' + szFilter, 'set');
			}
			var select = function(element) {
				element.parent().parent().parent().children().children(".radio").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
				//$(".radio").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
				element.parent().prev().html("&bullet;");
			}
			var clearFilter = function(szFilter) {
				ixmaps.changeThemeStyle(null, 'choropleth', 'filter', 'remove');
				ixmaps.changeThemeStyle(null, 'chart', 'filter', 'remove');
				ixmaps.changeThemeStyle(null, 'chart_prov', 'filter', 'remove');
				ixmaps.changeThemeStyle(null, 'chart_reg', 'filter', 'remove');
				ixmaps.changeThemeStyle(null, 'details', 'filter', 'remove');
				ixmaps.changeThemeStyle(null, 'province_sum', 'filter', 'remove');
				ixmaps.changeThemeStyle(null, 'regioni_sum', 'filter', 'remove');
			}


		</script>

		<style>
			table {
				background: #F7F6EF;
				border-radius: 0.3em;
				padding: 0.4em 0.8em;
			}

			td {
				border: dotted #888800 0.1px;
			}

			button {
				background: #F7F6EF;
				border: #dddddd solid 1px;
				border-radius: 0.3em;
				padding: 0.4em 0.8em;
			}

			button:hover {
				cursor: pointer;
			}

			.left {
				text-align: left;
			}

			a {
				text-decoration: none;
			}

		</style>

		<!-- ------------------------------------- -->
		<!-- dynamic theme info, changes on zoom   -->
		<!-- ------------------------------------- -->
		
		<div style="font-family:open sans;text-align:left;margin-left:1em;margin-top:0.5em;max-width:300px">
			Nel quadro della mappa ci sono attualmente visibile <span id="no_progetti" style="font-weight:bold;font-size:1.2em">...</span> progetti
			con un importo complessivo di<br><span id="sum_importi" style="font-weight:bold;font-size:1.8em">...</span>&nbsp; €<br>
			<span id="ambito-nazionale" style="display:none">di questi <span id="sum_importi_nazionali" style="font-weight:bold;font-size:1em">...</span>&nbsp; € in ambito nazionale</span>
			<span id="ambito-regionale" style="display:none">e <span id="sum_importi_tutti" style="font-weight:bold;font-size:1em">...</span>&nbsp; € in ambito regionale</span>
			
			<div id="filter-div" style="margin-top:0.8em;margin-right:2em;font-size:0.9em;background-color:beige;padding:0.2em;border-color:#aaaaaa;display:none">
				<span id="filter"></span>
				<button style="font-size:0.8em" onclick="ixmaps.message('rimuovo filtri ...');clearFilter();">x</button>
			</div>
			
		</div>
		<div style="font-family:open sans;text-align:left;margin-left:1em;margin-top:0.5em;max-width:300px">
			<p>
				<button onclick="ixmaps.popupThemeFacets(null,null,'missione')" ;>Missione</button>
				<button onclick="ixmaps.popupThemeFacets(null,null,'misura')" ;>Misura</button>
				<button onclick="ixmaps.popupThemeFacets(null,null,'categoria')" ;>Categoria</button>
				<button onclick="ixmaps.popupThemeFacets(null,null,'settore')" ;>Settore</button>
				<button onclick="ixmaps.popupThemeFacets(null,null,'Descrizione Regione')" ;>Regione</button>
				<button onclick="ixmaps.popupThemeFacets(null,null,'Descrizione Comune')" ;>Comune</button>
				<button onclick="ixmaps.popupThemeFacets(null,null)" ;>tutti filtri</button>
			</p>
		</div>
		
		<!-- ------------------------------------- -->
		<!-- static footer, annotations            -->
		<!-- ------------------------------------- -->
		
		<div style="font-family:open sans;text-align:left;margin-left:1em;margin-top:0.5em;max-width:300px">
			<hr>
			<p>Fonte dati:<br>Open CUP : Focus PNRR</p>
			<p>Descrizione dei dati ed istruzioni per l'uso si trovano qui sulla pagina dedicata di <a style="color:#0088dd" href="https://pnrr.datibenecomune.it/fonti/opencup/focus-pnrr.html" target="_blank">pnrr.datibenecomune.it</a></p>
			<p>Link ai dati: <a style="color:#0088dd" href="https://opencup.gov.it/portale/documents/21195/117121/progetti_cup_20230120.xlsx" target="_blank">progetti_cup_20230120.xlsx</a>
			</p>
			<!--
			<p><small><b>nota bene:</b><br> - si può clicare sui colori della leggenda per isolare 1 o più categorie<br>
					- per evitare tempi di aggiornamento grafici lunghi, conviene zoomare un po', prima di attivare l'aggregazione al livello comunale<small></small></p>
			-->
		</div>
		<div style="font-family:open sans;text-align:left;margin-left:1em;margin-top:0.5em;max-width:300px">
		</div>
		
		<table>
			<tr>
				<td>
					<button onclick="sizeCharts(0.90)">-</button>
				</td>
				<td>
					<span style="font-size:0.8em"> &nbsp; grandezza &nbsp;</span>
				</td>
				<td>
					<button onclick="sizeCharts(1.1)">+</button>
				</td>
			</tr>
			
			<!--
			<tr>
				<td>
					<button onclick="opacityCharts(0.75)">-</button>
				</td>
				<td>
					<span style="font-size:0.8em"> &nbsp; opacità &nbsp;</span>
				</td>
				<td>
					<button onclick="opacityCharts(1.5)">+</button>
				</td>
			</tr>
			<tr>
				<td>
					<button onclick="ixmaps.changeThemeStyle(null,'chart','type:GLOW','remove');">no</button>
				</td>
				<td>
					<span style="font-size:0.8em"> &nbsp; glow &nbsp;</span>
				</td>
				<td>
					<button onclick="ixmaps.changeThemeStyle(null,'chart','type:GLOW','add');">si</button>
				</td>
			</tr>
			<tr>
				<td>
					<button onclick="ixmaps.changeThemeStyle(null,'chart','aggregationfield:PROVINCIA','set');">prov.</button>
				</td>
				<td>
					<span style="font-size:0.8em"> &nbsp; aggregazione &nbsp;</span>
				</td>
				<td>
					<button onclick="ixmaps.changeThemeStyle(null,'chart','aggregationfield:COMUNE','set');">com.</button>
				</td>
			</tr>
			<tr>
				<td>
					<button onclick="ixmaps.removeTheme(null,'details');ixmaps.newTheme(null,__CUP_PNRR_PROJECTS);">sing.</button>
				</td>
				<td>
					<span style="font-size:0.8em"> &nbsp; progetti &nbsp;</span>
				</td>
				<td>
					<button onclick="ixmaps.removeTheme(null,'details');ixmaps.newTheme(null,__CUP_PNRR_PROJECTS_SUM);">somme</button>
				</td>
			</tr>
			-->
		</table>

		
		<div style="font-family:open sans;text-align:left;margin-left:1em;margin-top:0.5em;max-width:300px">
			<p>
				<button onclick="alert(ixmaps.szActualUrl)" ;>share</button>
			</p>
		</div>
		
		
	</div>

	<script>
		
		// ---------------------------------------------------
		// format number display 
		// ---------------------------------------------------

		/**
		 * convert a number into a formatted string; if the number > 1000 it will be formatted like 1 023 234 
		 * @param nValue the number to format
		 * @param nPrecision the wanted decimal points 
		 * @param szFlag "CEIL" or "FLOOR" (round either up or down)
		 */
		ixmaps.__formatValue = function(nValue, nPrecision, szFlag) {

			nValue = Number(nValue);

			if (!isFinite(nValue) || !isFinite(nPrecision)) {
				return String(nValue);
			}
			if (nValue == 0) {
				return String(nValue);
			}
			if (nValue > 1000000000000) {
				return String(nValue);
			}
			if (nValue < -1000000000000) {
				return String(nValue);
			}

			if (!nPrecision) {
				nPrecision = 0;
			}
			nPrecision = Math.max(0, nPrecision);

			// GR 02.12.2011 make that low values do not collapse to 0
			if ((nValue > 0.0000001) && (nPrecision > 0)) {
				while (nValue.toFixed(nPrecision - 1) == 0) {
					nPrecision++;
				}
			}

			// GR 11.03.2009 fix precision before CEIL or FLOOR to avoid JS errors eg. 0.0000000000003
			nValue = nValue.toFixed(nPrecision + 1);

			nClipDecimal = Math.pow(10, nPrecision);
			if (szFlag && szFlag.match(/CEIL/)) {
				nValue = Math.ceil(nValue * nClipDecimal) / nClipDecimal;
			} else
			if (szFlag && szFlag.match(/FLOOR/)) {
				nValue = Math.floor(nValue * nClipDecimal) / nClipDecimal;
			} else {
				nValue = Math.round(nValue * nClipDecimal) / nClipDecimal;
			}
			// format numbers > 1000
			if (0 && (nValue < 1000)) {
				return String(nValue);
			} else {
				var szDecimals = String(nValue);
				if (szDecimals.match(/\./)) {
					szDecimals = szDecimals.split(".")[1];
					while (szDecimals.length < nPrecision) {
						szDecimals += '0';
					}
				} else {
					szDecimals = "";
				}
				var szReturn = nValue < 0 ? "-" : "";
				var szLeading = "";

				nValue = Math.floor(Math.abs(nValue));

				// GR new flag
				if (!szFlag || !szFlag.match(/NOBREAKS/)) {
					var nClip = 1000;
					while (nValue > nClip) {
						nClip *= 1000;
					}
					nClip /= 1000;

					var nPart = 0;
					var szBreak = " ";
					while (nClip >= 1000) {
						nPart = Math.floor(nValue / nClip);
						szReturn += __maptheme_formatpart(nPart, szLeading);
						nValue = nValue % nClip;
						nClip /= 1000;
						if (nPart) {
							szLeading = "0";
							if (szFlag && szFlag.match(/SPACE/)) {
								szBreak = "<span style=\"font-size:0.5em;\">&nbsp;</span>";
							} else
							if (szFlag && szFlag.match(/BLANK/)) {
								szBreak = "&nbsp;";
							} else {
								szBreak = ".";
							}
						}
						szReturn += szBreak;
					}
				}

				szReturn += __maptheme_formatpart(nValue, szLeading);

				if (!szReturn.length || (szReturn == "-")) {
					szReturn += "0";
				}

				if (szDecimals.length && szDecimals != "00") {
					szReturn += ((szFlag && szFlag.match(/BLANK/)) ? "." : ",") + szDecimals;
				}
			}
			return szReturn;
		}
		/**
		 * helper to format a number from 0 to 999 into a string with leading character (sample 32 -> "032" )
		 * @param nPart the number to format
		 * @param szLeading the leading character to insert if necessary 
		 */
		function __maptheme_formatpart(nPart, szLeading) {
			if (!szLeading) {
				szLeading = "";
			}
			var szPart = "";
			if (nPart < 100) {
				szPart += szLeading;
			}
			if (nPart < 10) {
				szPart += szLeading;
			}
			if (nPart == 0) {
				szPart += szLeading;
			} else {
				szPart += String(nPart);
			}
			return szPart;
		}

		/**
		 * convert a number into a formatted string; if the number > 1000 it will be formatted like 1 023 234 
		 * @param nValue the number to format
		 */
		ixmaps.__bestFormatValue = function(nValue) {
			if (nValue >= 10) {
				return ixmaps.__formatValue(nValue, 0, "SPACE");
			} else
			if (nValue >= 1) {
				return ixmaps.__formatValue(nValue, 1, "SPACE");
			} else {
				return ixmaps.__formatValue(nValue, 2, "SPACE");
			}
		};

		// ---------------------------------------------------
		// create actual, map zoom dependent theme statistics 
		// ---------------------------------------------------

		ixmaps.statistics = function(szId) {
			
			console.log("---------------");
			console.log(szId);
			console.log("---------------");
			
			alert(ixmaps.data);

			var lastFilter = "";

			if (szId == "chart" || szId == "chart_prov" || szId == "chart_reg" || szId == "details") {
				var szFieldsA = ["importo"];
				alert(ixmaps.data.getFacets);
				var facetsA = ixmaps.data.getFacets(lastFilter, 'user_legend', szFieldsA, szId, "map");

				console.log("=== statistic facets done ===");

				// main 4 numbers
				console.log("---------------");
				console.log("---------------");
				console.log("---------------");
				console.log("---------------");
				console.log(ixmaps)
				
				var projects = ixmaps.__formatValue(facetsA[0].data.length, 0, "BLANK");
				var importi = ixmaps.__formatValue(facetsA[0].sum, 0, "BLANK");
				$("#no_progetti").html(projects);
				$("#sum_importi").html(importi);
				
				facetsA = ixmaps.data.getFacets("WHERE \"Descrizione Comune\" like \"ambito\"", 'user_legend', szFieldsA, szId, "map");
				if (facetsA[0].data && facetsA[0].data.length){
					projects = ixmaps.__formatValue(facetsA[0].data.length, 0, "BLANK");
					importi = ixmaps.__formatValue(facetsA[0].sum, 0, "BLANK");
					$("#no_progetti_nazionali").html(projects);
					$("#sum_importi_nazionali").html(importi);
					$("#ambito-nazionale").show();
				}else{
					$("#ambito-nazionale").hide();
				}

				facetsA = ixmaps.data.getFacets("WHERE \"Descrizione Comune\" like \"tutti\"", 'user_legend', szFieldsA, szId, "map");
				if (facetsA[0].data && facetsA[0].data.length){
					projects = ixmaps.__formatValue(facetsA[0].data.length, 0, "BLANK");
					importi = ixmaps.__formatValue(facetsA[0].sum, 0, "BLANK");
					$("#no_progetti_tutti").html(projects);
					$("#sum_importi_tutti").html(importi);
					$("#ambito-regionale").show();
				}else{
					$("#ambito-regionale").hide();
				}

				//$("#no_progetti").html(projects);
				//$("#importi").html(importi+" €");
				//$("#finanziati").html(finanziati+" €");
				//$("#pagamenti").html(pagamenti+" €");

			}
		};

		// ---------------------------------------------------
		//
		// theme change handler 
		//
		// ---------------------------------------------------
		
		var old_onDrawTheme = ixmaps.htmlgui_onDrawTheme;
		// intercept theme creation, to mark active themes
		ixmaps.htmlgui_onDrawTheme = function(szId) { 

			ixmaps.themesDrawnA = ixmaps.themesDrawnA || [];
			ixmaps.themesDrawnA[szId] = true;

			var themeObj = ixmaps.getThemeObj(szId);
			if (themeObj.szFlag.match(/NOLEGEND/)) {
				try {
					old_onDrawTheme(szId);
				} catch (e) {}
				return;
			};

			if (!themeObj.fVisible){
				return;
			}

			ixmaps.statistics(szId);
			
			var nOpacity = (ixmaps.getZoom()-7)/10;
			ixmaps.setBasemapOpacity(null,nOpacity,"absolute");


			if (themeObj.szFilter) {
				$("#filter").html(themeObj.szFilter);
				ixmaps.setTitle("<div style='font-family:open sans;font-size:0.7em;color:black;padding:0.5em;background:rgba(247, 246, 239, 0.5);width:30%'>filtro: " + themeObj.szFilter.split("WHERE")[1] + "</div>");
				$("#filter-div").show();
			} else {
				$("#filter").html("");
				ixmaps.setTitle("");
				$("#filter-div").hide();
			}

			
			ixmaps.szActualUrl = window.location.hostname+window.location.pathname;
			ixmaps.szActualUrl += "?filter="+themeObj.szFilter;
			ixmaps.szActualUrl += "&view=["+ixmaps.getCenter().lat+","+ixmaps.getCenter().lng+"],"+ixmaps.getZoom();
			
			try {
				old_onDrawTheme(szId);
			} catch (e) {}
		};
		
		
		
	// ===========================================
	//
	// h e l p e r
	//
	// ===========================================

	// get unique values array via filter
	var __onlyUnique = function (value, index, self) {
		return self.indexOf(value) === index;
	};

	// get unique values array via named array
	var __getUniqueValues = function(a) {
		var u = [];
		for ( var i in a ){
			u[String(a[i])] = 1;
		}
		var retA = [];
		for ( var v in u ){
			retA.push(v);
		}
		return retA;
	};

	// get numbers from formatted values like 235 678.98 or 235.678,98
	var __scanValue = function (nValue) {
		if (String(nValue).match(/:/)){
			return "date";
		} else
		// strips blanks inside numbers (e.g. 1 234 456 --> 1234456)
		if (String(nValue).match(/,/)) {
			return parseFloat(String(nValue).replace(/\./gi, "").replace(/,/gi, "."));
		} else {
			return parseFloat(String(nValue).replace(/ /gi, ""));
		}
	};

	// ===========================================
	//
	// facet filter handling 
	//
	// ===========================================
		
	ixmaps.data = ixmaps.data || {};	

	var __facetFilterA = [];
	var __rangesA = [];

	// ===========================================
	//
	// create filter facets from theme data
	//
	// ===========================================

	ixmaps.data.getFacets = function (szFilter,szDiv,szFieldsA,szId,szMap) {
		
		facetsA = [];

		var fTest = true;
		var sliderA = [];

		console.log("=== make statistic facets ===");
		
		var szThemeId = ixmaps.filterThemeId = szId;
	
		// theme object
		// ------------------------------------
		var objTheme = ixmaps.data.objTheme = ixmaps.map(szMap||"map").theme(szThemeId).obj;

		console.log("=== make statistic facets - 0 ===");

		// create data object from theme data
		// ------------------------------------
		var mydata = new Data.Table(null);
		mydata.table = objTheme.objTheme.dbTable;
		mydata.fields = objTheme.objTheme.dbFields;
		mydata.records = objTheme.objTheme.dbRecords;

		console.log("=== make statistic facets - 1 ===");

		// GR 23.02.2018 take only rows which are on the map
		// -------------------------------------------------
		records = [];
		try	{
			for ( i in objTheme.indexA ){
				if ( objTheme.itemA[objTheme.indexA[i]].dbIndex ){
					records.push(mydata.records[objTheme.itemA[objTheme.indexA[i]].dbIndex]);
				}
				if ( objTheme.itemA[objTheme.indexA[i]].dbIndexA ){
					for ( a in objTheme.itemA[objTheme.indexA[i]].dbIndexA ) {
						records.push(mydata.records[objTheme.itemA[objTheme.indexA[i]].dbIndexA[a]]);
					}
				}
			}
		}
		// maybe the data is not ready, then we repeat
		catch (e){
			setTimeout("ixmaps.data.makeFacets('"+szFilter+"','"+szDiv+"')",1000);
			console.log("error data not ready !!!");
			return;
		}

		mydata.records = records;
		
		console.log("=== make statistic facets - 2 ===");
		
		// if we have already a filter on the map,
		// filter data before creating facets
		// ------------------------------------
		if (szFilter && szFilter.match(/WHERE/)) {
			mydata = mydata.select(szFilter);

			// get filter parts
			// ----------------
			var szPartsA = szFilter.split('WHERE ')[1].split('AND');
			// test if BETWEEN x AND y and join two parts around AND
			for ( i=0; i<szPartsA.length; i++ ){
				if ( szPartsA[i].match(/BETWEEN/) ){
					szPartsA[i] = szPartsA[i] + "AND" + szPartsA[i+1];
					szPartsA.splice(i+1,1);
				}
			}
			// set filter parts
			// ----------------
			__facetFilterA = [];
			szPartsA.forEach(function(x){
				__facetFilterA.push(x);
			});
		}

		// make facets from data fields
		// ----------------------------

		console.log("=== make statistic facets - 3 ===");
		
		var a, u;
		
		szFieldsA = szFieldsA || mydata.columnNames();
		
		for (var i = 0; i < szFieldsA.length; i++) {
			
			var szField = szFieldsA[i];
			
			a = mydata.column(szField).values();
			
			// test for only numeric values
			// ----------------------------
			fNumeric = true;
			a.every(function (x) {
				if (x.length && (x != "NaN") && (x != "NULL") && isNaN(__scanValue(x))) {
					fNumeric = false;
				}
				return fNumeric;
			});

			// test if field already part of the active query 
			// ------------------------------------------
			var fActiveFacet = false;
			__facetFilterA.forEach(function (szFilter, index) {
				if ((szFilter.split("\"")[1] == szField) && ((szFilter.split("\"")[2] == " is ")||(szFilter.split("\"")[2] == " = "))) {
					fActiveFacet = true;
				}
			});

			// test for unique values 
			// -----------------------

			// first test maximal 250 values at the beginning 

			a.length = Math.min(a.length, 250);
			u = a.filter(__onlyUnique);

			// if we have many unique values and they are numbers,
			// make a numerique facet, if they are texts, skip field
			// -----------------------------------------------------
			if ((a.length >= 250) && (u.length >= (a.length / 5))) {

				if (fNumeric) {

					a = mydata.column(szField).values();
					var sum = 0;
					a = a.map(function (x) {
						x = __scanValue(x);
						sum += x||0;
						return (x);
					});
					a.sort(function (a, b) {
						return (a-b);
					});
					var facet = {};
					facet.id = szField;
					facet.min = a[0];
					facet.max = a[a.length - 1];
					facet.sum = sum;
					facet.values = a;
					facet.data = a;
					facetsA.push(facet);

				} else {
					// make input field to define filter 
					// ------------------------------------------
					var facet = {};
					facet.id = szField;
					facet.type = "textual";
					facet.example = a[0];

					if (fActiveFacet) {

						// add value list in any case 
						// ---------------------------
						facet.values = a;
						// count values
						var valuesCount = {};
						var nCount = {};
						a.forEach(function (x) {
							valuesCount[x] = (valuesCount[x] || 0) + 1;
                            nCount++;
						});
						facet.nCount = nCount;
						facet.valuesCount = valuesCount;
						facet.uniqueValues = a.length;
					}

					facetsA.push(facet);
				}
				continue;
			};

			// ok, data with many different values done
			// lets get all! unique values
			// -----------------------------------------

			a = mydata.column(szField).values();

			// get unique values array
			u = __getUniqueValues(a);

			// if less than 50 unique values, make text or number facet
			// --------------------------------------------------------

			if (u.length < 50 && !__rangesA[szField] && !fNumeric) {

				// count values
				var valuesCount = {};
				var nCount = 0;
				a.forEach(function (x) {
					valuesCount[x] = (valuesCount[x] || 0) + 1;
                    nCount++;
				});

				if (fNumeric) {
					u = u.map(function (x) {
						return Number(x);
					});
					u.sort(function (a, b) {
						return ((a > b) ? 1 : -1);
					});
				} else {
					u.sort();
					u.sort(function (a, b) {
						return ((valuesCount[a] < valuesCount[b]) ? 1 : -1);
					});
				}

				var facet = {};
				facet.id = szField;
				facet.values = u;
				facet.nCount = nCount;
				facet.valuesCount = valuesCount;
				facet.uniqueValues = u.length;

				if ((u.length >= 1) || fActiveFacet) {
					facet.type = "textual";
				}

				facetsA.push(facet);

			}
			else {

				// more than 50 unique values

				if ( fNumeric ) {
					if ( u.length > 0 ) {

						// if more than 3 values, make min/max range filter
						// ------------------------------------------
						a = mydata.column(szField).values();
						var min = Number.MAX_VALUE;
						var max = (-Number.MAX_VALUE);
						var fNaN = false;
						var sum = 0;
						a = a.map(function (x) {
							x = __scanValue(x);
							min = Math.min(min, x||min);
							max = Math.max(max, x||max);
							sum += x||0;
							return (x);
						});
						var facet = {};
						facet.id = szField;
						facet.min = min; //a[0];
						facet.max = max; //a[a.length-1];
						facet.sum = sum;
						facet.data = a;
						facet.uniqueValues = u.length;
						facet.type = "numeric";
						facetsA.push(facet);
						
					}else{
						
						// make input field to define filter 
						// ------------------------------------------
						var facet = {};
						facet.id = szField;
						facet.type = "categorical";
						console.log("categorical 1");
						if (u.length < 200) {
							// add value list
							// ---------------
							facet.values = u;
							var valuesCount = {};
							var nCount = 0;
							a.forEach(function (x) {
								valuesCount[x] = (valuesCount[x] || 0) + 1;
								nCount++;
							});
							u.sort(function (a, b) {
								return ((valuesCount[a] < valuesCount[b]) ? 1 : -1);
							});
							facet.nCount = nCount;
							facet.valuesCount = valuesCount;
							facet.uniqueValues = u.length;
						}
						facetsA.push(facet);
						
					}

				} else {

					// if not numeric, make input field to define filter 
					// ------------------------------------------
					var facet = {};
					facet.id = szField;
					facet.type = "textual";
					if (u.length < 200) {
						// add value list
						// ---------------
						facet.values = u;
						var valuesCount = {};
						var nCount = 0;
						a.forEach(function (x) {
							valuesCount[x] = (valuesCount[x] || 0) + 1;
                            nCount++;
						});
						u.sort(function (a, b) {
							return ((valuesCount[a] < valuesCount[b]) ? 1 : -1);
						});
						facet.nCount = nCount;
						facet.valuesCount = valuesCount;
						facet.uniqueValues = u.length;
					}
					facetsA.push(facet);
				}
			}
		}
		console.log("=== make statistic facets - end ===");
		return facetsA;
	};

		
		
		

	</script>




</body>

</html>
