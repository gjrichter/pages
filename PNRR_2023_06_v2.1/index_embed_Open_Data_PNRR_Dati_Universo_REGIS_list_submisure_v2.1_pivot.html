<!DOCTYPE html>
<html>

<!-- **********************************************************************

ixmaps map embed html

$Comment: ixmaps map template; embedded version
$Source : index_only_map_embed.html,v $

$InitialAuthor: guenter richter $
$InitialDate: 2023/04/22 $
$Author: guenter richter $
$Id:index_embed_Open_Data_PNRR_Dati_Universo_REGIS_III.html 1 2023-04-22 00:00:00Z Guenter Richter $

licensed under CC-BY
$Log:index_only_map_embed.html,v $

********************************************************************** -->

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta name="description" content="ixmaps embed example">
	<meta name="author" content="guenter richter">
	<link rel="shortcut icon" href="https://gjrichter.github.io/ixmaps/ui/resources/images/ixmaps_logo.png">

	<title>Dati aperti PNRR: get submisure</title>

	<style>
		body,
		h1,
		h2,
		h3,
		h4,
		h5,
		p,
		table {
			font-family: sans-serif;
		}

		td,
		th {
			padding: 0.5em;
		}

		td {
			cursor: pointer;
		}

		.M1 {
			background-color: #C7E4EE;
		}

		.M2 {
			background-color: #D8E6BF;
		}

		.M3 {
			background-color: #F3C0C2;
		}

		.M4 {
			background-color: #F6DCBE;
		}

		.M5 {
			background-color: #E3CEE9;
		}

		.M6 {
			background-color: #F7E9BD;
		}

		.gray {
			color: gray;
		}

	</style>
</head>

<body style='text-align:center;background:#F7F6EF'>

	<h1>PNRR - Universum REGIS v2.1 - analisi delle Submisure</h1>
	<div id="list-codici-submisure" style="margin:0em;font-size:1em;text-align:left;max-width: 1024px;margin:auto"><div style="text-align:center"><img src="./img/loading_blue.gif"></div></div>

	<div id="list-submisura-header" style="margin:0em;font-size:1em;text-align:left;max-width: 1024px;margin:auto"></div>
	<div id="list-regioni" style="margin:0em;font-size:1em;text-align:left;max-width: 1024px;margin:auto"></div>

	<iframe id="map1" style="border:none;width:49%;height:840px"></iframe>
	<iframe id="map2" style="border:none;width:49%;height:840px"></iframe>


	<!-- ------------------------------------- -->
	<!--                                       -->
	<!-- c o d e                         -->
	<!--                                       -->
	<!-- ------------------------------------- -->

	<!--========================================================================= -->

	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
	<script src="https://gjrichter.github.io/ixmaps/ui/js/htmlgui_api.js"></script>
	<script type="text/javascript" src="https://gjrichter.github.io/data.js/data.js"></script>
	<script src="./data.extend.facets.js"></script>
	<script src="./json.js"></script>

	<!--========================================================================= -->

	<script type="text/javascript" charset="utf-8">
		// ---------------------------------------------------
		// format number display 
		// ---------------------------------------------------

		/**
		 * convert a number into a formatted string; if the number > 1000 it will be formatted like 1 023 234 
		 * @param nValue the number to format
		 * @param nPrecision the wanted decimal points 
		 * @param szFlag "CEIL" or "FLOOR" (round either up or down)
		 */
		ixmaps.__formatValue = function(nValue, nPrecision, szFlag) {

			nValue = Number(nValue);

			if (!isFinite(nValue) || !isFinite(nPrecision)) {
				return String(nValue);
			}
			if (nValue == 0) {
				return String(nValue);
			}
			if (nValue > 1000000000000) {
				return String(nValue);
			}
			if (nValue < -1000000000000) {
				return String(nValue);
			}

			if (!nPrecision) {
				nPrecision = 0;
			}
			nPrecision = Math.max(0, nPrecision);

			// GR 02.12.2011 make that low values do not collapse to 0
			if ((nValue > 0.0000001) && (nPrecision > 0)) {
				while (nValue.toFixed(nPrecision - 1) == 0) {
					nPrecision++;
				}
			}

			// GR 11.03.2009 fix precision before CEIL or FLOOR to avoid JS errors eg. 0.0000000000003
			nValue = nValue.toFixed(nPrecision + 1);

			nClipDecimal = Math.pow(10, nPrecision);
			if (szFlag && szFlag.match(/CEIL/)) {
				nValue = Math.ceil(nValue * nClipDecimal) / nClipDecimal;
			} else
			if (szFlag && szFlag.match(/FLOOR/)) {
				nValue = Math.floor(nValue * nClipDecimal) / nClipDecimal;
			} else {
				nValue = Math.round(nValue * nClipDecimal) / nClipDecimal;
			}
			// format numbers > 1000
			if (0 && (nValue < 1000)) {
				return String(nValue);
			} else {
				var szDecimals = String(nValue);
				if (szDecimals.match(/\./)) {
					szDecimals = szDecimals.split(".")[1];
					while (szDecimals.length < nPrecision) {
						szDecimals += '0';
					}
				} else {
					szDecimals = "";
				}
				var szReturn = nValue < 0 ? "-" : "";
				var szLeading = "";

				nValue = Math.floor(Math.abs(nValue));

				// GR new flag
				if (!szFlag || !szFlag.match(/NOBREAKS/)) {
					var nClip = 1000;
					while (nValue > nClip) {
						nClip *= 1000;
					}
					nClip /= 1000;

					var nPart = 0;
					var szBreak = " ";
					while (nClip >= 1000) {
						nPart = Math.floor(nValue / nClip);
						szReturn += __maptheme_formatpart(nPart, szLeading);
						nValue = nValue % nClip;
						nClip /= 1000;
						if (nPart) {
							szLeading = "0";
							if (szFlag && szFlag.match(/SPACE/)) {
								szBreak = "<span style=\"font-size:0.5em;\">&nbsp;</span>";
							} else
							if (szFlag && szFlag.match(/BLANK/)) {
								szBreak = "&nbsp;";
							} else {
								szBreak = ".";
							}
						}
						szReturn += szBreak;
					}
				}

				szReturn += __maptheme_formatpart(nValue, szLeading);

				if (!szReturn.length || (szReturn == "-")) {
					szReturn += "0";
				}

				if (szDecimals.length && szDecimals != "00") {
					szReturn += ((szFlag && szFlag.match(/BLANK/)) ? "." : ",") + szDecimals;
				}
			}
			return szReturn;
		}

		/**
		 * helper to format a number from 0 to 999 into a string with leading character (sample 32 -> "032" )
		 * @param nPart the number to format
		 * @param szLeading the leading character to insert if necessary 
		 */
		function __maptheme_formatpart(nPart, szLeading) {
			if (!szLeading) {
				szLeading = "";
			}
			var szPart = "";
			if (nPart < 100) {
				szPart += szLeading;
			}
			if (nPart < 10) {
				szPart += szLeading;
			}
			if (nPart == 0) {
				szPart += szLeading;
			} else {
				szPart += String(nPart);
			}
			return szPart;
		}

		/**
		 * convert a number into a formatted string; if the number > 1000 it will be formatted like 1 023 234 
		 * @param nValue the number to format
		 */
		ixmaps.__bestFormatValue = function(nValue) {
			if (nValue >= 10) {
				return ixmaps.__formatValue(nValue, 0, "SPACE");
			} else
			if (nValue >= 1) {
				return ixmaps.__formatValue(nValue, 1, "SPACE");
			} else {
				return ixmaps.__formatValue(nValue, 2, "SPACE");
			}
		};


		var regisData = null;

		var submisureA = [];
		var subFilterA = [];
		var subImportoA = [];
		var subProjectsA = [];
		var subInGaraA = [];
		var subAggiudicatoA = [];

		var regfilterA = [];

		var inGaraA = null;
		var aggiudicatoA = null;
		var importoA = null;
		var projectsA = null;

		var missioniDescrA = {
			"M1": "M1 - Digitalizz., innov., competi., cultura e turismo",
			"M2": "M2 - Rivoluzione verde e trans. eco.",
			"M3": "M3 - Infrastrutture per una mobilità sostenibile",
			"M4": "M4 - Istruzione e ricerca",
			"M5": "M5 - Inclusione e coesione",
			"M6": "M6 - Salute"
		};

		exploreSubmisura = function(i) {
			
			if ( $("#map-div"+i).html().length ){
				$("#map-div"+i).html("");
				return;
				}


			var filter = subFilterA[i];
			var legend = null;
			var submisura = filter.split("=")[2].split("AND")[0];

			var szHtml = "";
			szHtml += "<h1>" + (decodeURIComponent(submisura)) + "</h1>";
			szHtml += "<div style='text-align:center'><h1>" +
				ixmaps.__bestFormatValue(subImportoA[i]) + " <span class='gray'>€  </span></h1><h2>" +
				ixmaps.__bestFormatValue(subProjectsA[i]) + " <span class='gray'>progetti</span>&nbsp;&nbsp; " +
				ixmaps.__bestFormatValue(subInGaraA[i] + subAggiudicatoA[i]) + " <span class='gray'>gare</span>&nbsp;&nbsp; " +
				ixmaps.__bestFormatValue(subAggiudicatoA[i]) + " <span class='gray'>aggiudicazioni</span></h2></div>";


			//$("#list-submisura-header").html(szHtml);
			
			var szMap1Id = "map1_"+i;
			var szMap2Id = "map2_"+i;
			var szView = "[41.44272637767212,11.40380859375],5.6";
			
			szHtml = '<iframe id="'+szMap1Id+'" style="border:none;width:50%;height:720px"></iframe>' +
					 '<iframe id="'+szMap2Id+'" style="border:none;width:50%;height:720px"></iframe>';
			
			$("#map-div"+i).html(szHtml);

			legend = "<h1>Tutti progetti (" + subProjectsA[i] + ")<h1>";
			$("#"+szMap1Id).attr("src", 'http://localhost/ixmaps/deploy/rc-exp/ixmaps/pages/PNRR - Small Multiples/index_embed_Open_Data_PNRR_Dati_Universo_REGIS_final_small_pivot_template_v2.1.html?' + filter + '&legend=' + legend + '&view=' + szView);

			legend = "<h1>Progetti in gara (" + subInGaraA[i] + ") o aggiudicati (" + subAggiudicatoA[i] + ")<h1>";
			$("#"+szMap2Id).attr("src", 'http://localhost/ixmaps/deploy/rc-exp/ixmaps/pages/PNRR - Small Multiples/index_embed_Open_Data_PNRR_Dati_Universo_REGIS_final_small_pivot_template_v2.1.html?' + filter + ' AND \"stato di avanzamento\" in (\"in gara\",\"aggiudicato\")' + '&legend=' + legend + '&view=' + szView);

			/**
			$("html, body").animate({
				scrollTop: $(document).height()
			}, 1000);
			**/
		};



		listSubmisura_II = function() {

			var szUrl = "https://s3.eu-west-1.amazonaws.com/data.ixmaps.com/PNRR_2023_06_v2.1/PNRR_Localizzazione-Universo_REGIS_pivot_submisure_v2.1.csv.gz";
			var myfeed = Data.feed({
					"source": szUrl,
					"type": "csv"
				})
				.error(function(e) {
					console.log("load error:" + e.status + " - " + szUrl)
				})
				.load(function(mycdata) {
					
					console.log(mycdata);

					submisureA = mycdata.column("Codice Univoco Submisura").values();
					var descrizioneSubmisureA = mycdata.column("Descrizione Submisura").values();

					inGaraA = mycdata.column("in gara").values();
					aggiudicatoA = mycdata.column("aggiudicato").values();
					importoA = mycdata.column("importo").values();
					projectsA = mycdata.column("projects").values();
					
					var aggiudicatoIndex = mycdata.column("aggiudicato").index;
					var ingaraIndex = mycdata.column("in gara").index;
					var projectsIndex = mycdata.column("projects").index;
					
					mycdata.addColumn({
						destination: "aggiudicato_perc"
					}, function(row) {
						return isNaN(row[aggiudicatoIndex]) ? 0 : (Number(row[aggiudicatoIndex])/Number(row[projectsIndex])*100);
					})
					
					mycdata.addColumn({
						destination: "con_gara_perc"
					}, function(row) {
						return isNaN(row[aggiudicatoIndex]) ? 0 : ((Number(row[ingaraIndex])+Number(row[aggiudicatoIndex]))/Number(row[projectsIndex])*100);
					})
					
					

					var szHtml = "";

					var sum = 0;
					for (i in importoA) {
						sum += Number(importoA[i]);
					}
					var projects = 0;
					for (i in projectsA) {
						projects += Number(projectsA[i]);
					}
					var gare = 0;
					for (i in inGaraA) {
						gare += Number(inGaraA[i]);
					}
					var garevinte = 0;
					for (i in aggiudicatoA) {
						garevinte += Number(aggiudicatoA[i]);
					}

					szHtml += "<div style='text-align:center'><h1>" + ixmaps.__bestFormatValue(sum) + " <span class='gray'>€  </span></h1><h2>" +
						ixmaps.__bestFormatValue(projects) + " <span class='gray'>progetti</span>&nbsp;&nbsp; " +
						ixmaps.__bestFormatValue(gare + garevinte) + " <span class='gray'>gare</span>&nbsp;&nbsp; " +
						ixmaps.__bestFormatValue(garevinte) + " <span class='gray'>aggiudicazioni</span></h2></div>";

					var missioniA = [];
					missioniA.push(mycdata.select("WHERE \"Codice Univoco Submisura\" like \"M1\""));
					missioniA.push(mycdata.select("WHERE \"Codice Univoco Submisura\" like \"M2\""));
					missioniA.push(mycdata.select("WHERE \"Codice Univoco Submisura\" like \"M3\""));
					missioniA.push(mycdata.select("WHERE \"Codice Univoco Submisura\" like \"M4\""));
					missioniA.push(mycdata.select("WHERE \"Codice Univoco Submisura\" like \"M5\""));
					missioniA.push(mycdata.select("WHERE \"Codice Univoco Submisura\" like \"M6\""));


					var count = 0;

					for (i in missioniA) {
						
						szHtml += "<div>";
						szHtml += "<table>";
						
						missioniA[i].sort("aggiudicato_perc").revert();

						var submisureA = missioniA[i].column("Codice Univoco Submisura").values();
						var descrizioneSubmisureA = missioniA[i].column("Descrizione Submisura").values();
						var inGaraA = missioniA[i].column("in gara").values();
						var aggiudicatoA = missioniA[i].column("aggiudicato").values();
						var importoA = missioniA[i].column("importo").values();
						var projectsA = missioniA[i].column("projects").values();
						var aggiud_percA = missioniA[i].column("aggiudicato_perc").values();
						var con_gara_percA = missioniA[i].column("con_gara_perc").values();

						szHtml += "<tr'><td style='padding-top:2em;font-size:1.5em;padding-left:0.35em' colspan='4'>" + missioniDescrA[submisureA[0].substring(0, 2)] + "</td></tr>";
						szHtml += "<tr>";
						szHtml += "<th>Submisura</th>" +
							"<th>Descrizione submisura</th>" +
							"<th style='text-align:right'>Importo</th>" +
							"<th style='text-align:right'>Progetti</th>" +
							"<th style='text-align:right'>con gara</th>" +
							"<th style='text-align:right'>aggiudicati</th>";
						szHtml += "</tr>";



						var nProgetti = 0,
							nImporto = 0,
							nInGara = 0,
							nAggiudicato = 0;

						for (ii in submisureA) {
							var mission = submisureA[ii].substring(0, 2);

							subFilterA[count] = "filter=WHERE \"Descrizione Submisura\" = \"" + (encodeURIComponent(descrizioneSubmisureA[ii])) + "\"";
							subImportoA[count] = importoA[ii];
							subProjectsA[count] = projectsA[ii];
							subInGaraA[count] = inGaraA[ii];
							subAggiudicatoA[count] = aggiudicatoA[ii];

							szHtml += "<tr onclick='exploreSubmisura(" + count + ")'>" +
								"<td class='" + mission + "' style='width:20px;vertical-align:top'>" + submisureA[ii] + "</td>" +
								"<td class='" + mission + "' style='width:400px;vertical-align:top'>" + descrizioneSubmisureA[ii] + "</td>" +
								"<td class='" + mission + "' style='vertical-align:top;text-align:right;width:150px'>" + ixmaps.__bestFormatValue(importoA[ii]) + " €</td>" +
								"<td class='" + mission + "' style='vertical-align:top;text-align:right;width:120px'>" + projectsA[ii] + " progetti</td>" +
								"<td class='" + mission + "' style='vertical-align:top;text-align:right;width:80px'>" +
								(con_gara_percA[ii]).toFixed(1) + "% <img src='./img/megafono.png' height='16px'></td>" +
								"<td class='" + mission + "' style='vertical-align:top;text-align:right;width:80px'>" +
								(aggiud_percA[ii]).toFixed(1) + "% <img src='./img/515345.png' height='16px'></td>" +
								"<td></td></tr>";
							
							szHtml += "<tr><td style='spacing:0em;padding:0em' colspan='9'><div id='map-div"+count+"' ></div></td></tr>";

							nProgetti += Number(projectsA[ii]);
							nImporto += Number(importoA[ii]);
							nInGara += Number(inGaraA[ii]);
							nAggiudicato += Number(aggiudicatoA[ii]);

							count++;
						}

						if (1 || nImporto) {
							szHtml += "<tr>";
							szHtml += "<th></th>" +
								"<th></th>" +
								"<th style='text-align:right'>" + ixmaps.__bestFormatValue(nImporto) + " €</th>" +
								"<th style='text-align:right'>" + nProgetti + " progetti</th>" +
								"<th style='text-align:right'>" + ((nInGara + nAggiudicato) / nProgetti * 100).toFixed(2) + "% </th>" +
								"<th style='text-align:right'>" + ((nAggiudicato) / nProgetti * 100).toFixed(2) + "% </th>";
							szHtml += "</tr>";
						}
						szHtml += "</table>";
						szHtml += "</div>";
					}


					szHtml += "</br>";
					szHtml += "</br>";
					szHtml += "</br>";
					szHtml += "</br>";



					$("#list-codici-submisure").html(szHtml);
				});
		};





		listSubmisura_II();

	</script>

</body>

</html>
