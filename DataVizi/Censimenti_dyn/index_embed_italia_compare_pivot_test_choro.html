<!DOCTYPE html>
<html>

<!-- **********************************************************************

ixmaps map embed html

$Comment: ixmaps map template; embedded version
$Source : index_only_map_embed.html,v $

$InitialAuthor: guenter richter $
$InitialDate: 2023/04/22 $
$Author: guenter richter $
$Id:index_embed_Open_Data_PNRR_Dati_Universo_REGIS_III.html 1 2023-04-22 00:00:00Z Guenter Richter $

licensed under CC-BY
$Log:index_only_map_embed.html,v $

********************************************************************** -->

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="ixmaps embed example">
    <meta name="author" content="guenter richter">
    <link rel="shortcut icon" href="https://gjrichter.github.io/ixmaps/ui/resources/images/ixmaps_logo.png">

    <title>Data VizI</title>
    <meta name="description" content="Le mappe con dati italiani">

    <style>
        a {
            text-decoration: none;
            color: #444444;
        }

        a:hover {
            color: cornflowerblue;
        }

        ul {
            font-family: Raleway;
            padding-inline-start: 1.5em;
        }

        li.active a {
            color: white;
            background-color: #24A2AF;
            xxpadding: 0.2em;
        }

        a.active {
            color: white;
            background-color: #24A2AF;
            xxpadding: 0.2em;
        }

        .sidebar {
            position: absolute;
            right: 5%;
            top: 110px;
            text-align: left;
            font-family: Helvetica;
            font-size: 1.1em;
            line-height: 1.2em;
            max-width: 28%;
            background-color: rgba(247, 246, 239, 0.8)
        }

    </style>
    <style>
        #myRange1,
        #myRange2 {
            vertical-align: -2px;
            accent-color: #888888;
        }

        input[type=range]::-webkit-slider-runnable-track {
            background: #eeeeee;
            border-radius: 1em;
        }

    </style>

</head>

<body style='text-align:center;background:#F7F6EF;margin:0;padding:0'>

    <div id="logo" style="position:absolute;top:25px;right:6%">
        <a href="javascript:__dataTheme()">
            <div style="font-family:helvetica;font-size:48px;line-height:0.8em;font-weight:bold;color:burlywood ;text-align:left">Data<br><span style="font-size:48px;padding-left:2px">Viz</span><em> i</em></div>
        </a>
    </div>


    <div style="margin:auto">


        <div id="map_div"></div>


        <div id="sidebar_div" class="sidebar">
            <p style="font-family:helvetica;font-size:2em;line-height:0.73em;margin:0.5em">
                <b>Censimenti 2011/2021</b>
                <br>
                <small style='font-size:0.75em;color:#888888'>Visualizzazione di dati pubblicati dall'ISTAT in <a href="" target="_blank" style="color:cadetblue">Basi territoriali e variabili censuarie</a></small>
            </p>
            <ul>
                <li>
                    <a class="select" href="javascript:ixmaps.map().add(__sez_2011_2021_pop_arrow_user())">Popolazione</a>
                    <ul>
                        <li>
                            <a class="select active" href="javascript:ixmaps.map().remove('chart').add(__sez_2011_2021_pop_arrow_user(),'replace')"> Variazione della popolazione</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().remove('chart').add(__sez_2011_2021_pop_arrow_eta_meno_5(),'replace')"> - fascia d'età < 5 anni</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().remove('chart').add(__sez_2011_2021_pop_arrow_eta_5_9())"> - fascia d'età 5 - 9 anni</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().remove('chart').add(__sez_2011_2021_pop_arrow_eta_piu_75_peaks())"> - fascia d'età > 75 anni</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().remove('chart').add(__sez_2011_2021_pop_arrow_eta_meno_5()).add(__sez_2011_2021_pop_arrow_eta_piu_75_peaks())"> - fascia d'età < 5 e> 75 anni</a>
                        </li>

                    </ul>
                </li>
                <li>
                    <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021(),'clear').add(__sez2021_edu_choropleth())">Istruzione</a>
                    <ul>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez_2011_2021_pop_arrow_edu_terzo(),'clear')"> - diploma di terzo grado</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez_2011_2021_pop_arrow_edu_media(),'clear')"> - diploma di scuola media</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez_2011_2021_pop_arrow_edu_elementare(),'clear')"> - diploma di scuola elementare</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021(),'clear').add(__sez2021_edu_choropleth())">Stranieri</a>
                    <ul>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez_2011_2021_pop_arrow_stranieri(),'clear')"> - Stranieri e apolidi residenti in Italia - totale</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="select" href="javascript:ixmaps.map().add(__georef_sez2021(),'clear').add(__sez2021_edu_choropleth())">Fondo</a>
                    <ul>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().remove('choropleth')"> - remove choropleth</a>
                        </li>
                        <li>
                            <a class="select active" href="javascript:ixmaps.map().add(__sez2021_pop_choropleth(),'replace')"> - densità della popolazione1</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez2021_stranieri_choropleth(),'replace')"> - provenienza stranieri predominante 2021</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez2021_eta_choropleth(),'replace')"> - classe eta prevalente 2021</a>
                        </li>
                        <li>
                            <a class="select" href="javascript:ixmaps.map().add(__sez2021_edu_choropleth(),'replace')"> - grado di istruzione prevalente 2021</a>
                        </li>
                    </ul>
                </li>
            </ul>
                <div style="position:relative;top:0px;left:20px">
        <p style='font-family:open sans;color:#888888;z-index:999999'>
            <span style="font-size:0.8em">grandezza grafici:</span>
            <input type='range' min='0.1' max='2' step="0.01" value='1' class='slider' id='myRange1'>
            <!--
            <span style="font-size:0.6em">aggregazione: da 5
                <input type='range' min='5' max='100' step="5" value='100' class='slider' id='myRange2'> a 100 pixel</span>
            -->
        </p>
    </div>

        </div>

        <div id="map_code_div-project" style="position:absolute;top:10px;left:10px;text-align:left;width:50%;height:800px;overflow:auto;display:none;xxbox-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);"></div>
    </div>

    <!-- ------------------------------------- -->
    <!--                                       -->
    <!-- c o d e                         -->
    <!--                                       -->
    <!-- ------------------------------------- -->

    <!--========================================================================= -->

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
	<script type="text/javascript" src="https://gjrichter.github.io/ixmaps_test/ui/js/htmlgui_api.js"></script>


    <!--========================================================================= -->

    <script type="text/javascript" charset="utf-8">
        /** 
         ** change background color on select
         **/

        __select = (el) => {
            $(".select").removeClass("active");
            el.addClass("active");
        };
        $(".select").attr("onclick", "__select($(this))");
        
        var setChartSize = function(nValue) {
            ixmaps.changeThemeStyle(null, 'chart', 'scale:' + nValue, 'set');
            ixmaps.changeThemeStyle(null, 'chart_procom_all', 'scale:' + nValue, 'set');
        }
        var setGrid = function(nValue) {
            ixmaps.changeThemeStyle(null, 'chart', 'gridwidthpx:' + nValue, 'set');
            ixmaps.changeThemeStyle(null, 'chart_grid', 'gridwidthpx:' + nValue, 'set');

        }
        var slider = document.getElementById("myRange1");
        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {
            if (ixmaps.sliderT1) {
                clearTimeout(ixmaps.sliderT1);
            }
            ixmaps.value = this.value;
            ixmaps.sliderT1 = setTimeout(function() {
                setChartSize(ixmaps.value)
            }, 10);
        }
        /**
        slider = document.getElementById("myRange2");
        // Update the current slider value (each time you drag the slider handle)
        slider.oninput = function() {
            if (ixmaps.sliderT2) {
                clearTimeout(ixmaps.sliderT2);
            }
            ixmaps.value = this.value;
            ixmaps.sliderT2 = setTimeout(function() {
                setGrid(ixmaps.value)
            }, 250);
        }
        **/

        // ---------------------------------------------------
        // ---------------------------------------------------
        //
        // t h e   m a p 
        //
        // ---------------------------------------------------
        // ---------------------------------------------------

        /**
         ** ************************************
         ** define the ixmaps themes and project
         ** ************************************
         **/

        var __filter = "";
        var __lat = null;
        var __lon = null;
        var __zoom = null;
        var __scale_chart = 1;
        var __legend = true;

        /**
         ** strings used by the map 	
         **/

        attribution =
            "powered by <a href=\"http://ixmaps.com\" target=\"_blank\">iXMaps</a>";

        /**
         ** get query params and adapt theme and project definitions 	
         **/

        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });

        if (params.filter) {
            __filter = params.filter;
        }

        if (params.view) {
            var latlonA = params.view.split('[')[1].split(']')[0].split(',');
            __lat = latlonA[0];
            __lon = latlonA[1];
            __zoom = parseFloat(params.view.split(',')[2]);
            //setTimeout("ixmaps.setView(null,"+params.view+")",1000);
        };

        if (params.scale) {
            __scale_chart = params.scale;
        };

        if (params.legend) {
            __legend = params.legend;
        };


        ixmaps.regione = "03";
        ixmaps.procom = "*";

        $.getScript("./layer_compare.js");

        const nuts2 =
            ixmaps.layer("nuts2", layer => layer
                .type("FEATURES|SILENT|NOLEGEND")
                .data({
                    url: "https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_10M_2021_4326_LEVL_2.geojson",
                    type: "geojson"
                })
                .binding({
                    id: "NUTS_ID"
                })
                .filter("WHERE CNTR_CODE = IT")
                .style({
                    colorscheme: [
                        "white"
                    ],
                    fillopacity: "0.8",
                    linecolor: "#F7F6EF",
                    linewidth: "2",
                    showdata: true,
                    featurelower: "1:500000",
                    titlefield: "NUTS_NAME",
                    name: "nuts2"
                })
            );

        // ---------------------------------------------------
        // e m b e d   t h e   m a p  
        // ---------------------------------------------------

        /**
         **
         ** create the interactive map an append it to the document 
         **
         **/

        ixmaps.embed("map_div", {
                mapService: "leaflet_vt",
                mapType: "VT_TONER_LITE",
                map: "../../maps/svg/maps/generic/mercator.svg",
                legend: ((__legend == true) ? "true" : 0),
                align: "left",
                mode: "pan",
                about: "test",
                search: "Italy"
            },
            map => map

            .view({
                "center": {
                    "lat": "42.30234655149951",
                    "lng": "13.987399620595363"
                },
                "zoom": "6.27681771091248"
            })
            .options({
                featurescaling: "true",
                objectscaling: "dynamic",
                normalSizeScale: "50000",
                dynamicScalePow: "1.7",
                flushChartDraw: "1000000",
                flushPaintShape: "1000000",
                basemapopacity: "0.5",
                hideOnPan: "false",
                freezeOnPan: "true"
            })
            .local("aggregated", "")
            .local("... creating theme ...", "...")
            .local("loading data ...", "scaricando dati ...")
            .require("../../ui/js/tools/tooltip_mustache.js")
            .require("https://d3js.org/d3.v3.min.js")
            .require("https://gjrichter.github.io/pages/DataVizi/js/chart.js")
            .require("https://gjrichter.github.io/pages/DataVizi/js/arrow_chart.js")
            .attribution(attribution)
            //.legend("<h1 style='padding:0.2em 0.5em;border-radius:0.5em;background:RGBA(255,255,255,0.5)'>Variazione della <span style='color:#884488'>fascia d'età 65+  (%)</span> dal 2003 al 2023 </h1>")		 

            // -----------------------------		 
            // the data visualization layer 
            // -----------------------------

            .layer(nuts2)
            //.layer(__georef_urban())
            .layer(__georef())
            .layer(__georef_sez2021())
            //.layer(__georef_sez2011)
            .layer(__sez2021_pop_choropleth())
            //.layer(__sez2011_pop_100_circle)
            //.layer(__sez2021_pop_100_circle)
            //.layer(__sez_2011_2021_pop_arrow_user_procom_all_grid())
            .layer(__sez_2011_2021_pop_arrow_user_procom_all())
            .layer(__sez_2011_2021_pop_arrow_user_grid())
            .layer(__sez_2011_2021_pop_arrow_user())
         );

        /**
         **
         ** window size handling
         **
         **/

        $(window).resize(function() {
            $("#regis_map").css("height", (window.innerHeight - 5) + "px");
        });

        // ----------------------------------------------
        // things to do on zoom and pan
        // ----------------------------------------------

        // define map lookup table; name -> svg file
        // -----------------------------------------
        var regionLookup = [{
                name_en: "Piedmont",
                name_it: "Piemonte",
                name_s: "PIE",
                name_nuts: "ITC1",
                data: "01"
            },
            {
                name_en: "Aosta Valley",
                name_it: "Valle d'Aosta",
                name_s: "VAL",
                name_nuts: "ITC2",
                data: "02"
            },
            {
                name_en: "Lombardy",
                name_it: "Lombardia",
                name_s: "LOM",
                name_nuts: "ITC4",
                data: "03"
            },
            {
                name_en: "Trentino-Alto Adige",
                name_it: "Trentino-Alto Adige",
                name_s: "TRE",
                name_nuts: "ITH1",
                data: "04"
            },
            {
                name_en: "Trentino-Alto Adige",
                name_it: "Trentino-Alto Adige",
                name_s: "TRE",
                name_nuts: "ITH2",
                data: "04"
            },
            {
                name_en: "Veneto",
                name_it: "Veneto",
                name_s: "VEN",
                name_nuts: "ITH3",
                data: "05"
            },
            {
                name_en: "Friuli Venezia Giulia",
                name_it: "Friuli Venezia Giulia",
                name_s: "FRI",
                name_nuts: "ITH4",
                data: "06"
            },
            {
                name_en: "Liguria",
                name_it: "Liguria",
                name_s: "LIG",
                name_nuts: "ITC3",
                data: "07"
            },
            {
                name_en: "Emilia-Romagna",
                name_it: "Emilia-Romagna",
                name_s: "EMI",
                name_nuts: "ITH5",
                data: "08"
            },
            {
                name_en: "Tuscany",
                name_it: "Toscana",
                name_s: "TOS",
                name_nuts: "ITI1",
                data: "09"
            },
            {
                name_en: "Umbria",
                name_it: "Umbria",
                name_s: "UMB",
                name_nuts: "ITI2",
                data: "10"
            },
            {
                name_en: "The Marches",
                name_it: "Marche",
                name_s: "MAR",
                name_nuts: "ITI3",
                data: "11"
            },
            {
                name_en: "Latium",
                name_it: "Lazio",
                name_s: "LAZ",
                name_nuts: "ITI4",
                data: "12"
            },
            {
                name_en: "Abruzzo",
                name_it: "Abruzzo",
                name_s: "ABR",
                name_nuts: "ITF1",
                data: "13"
            },
            {
                name_en: "Molise",
                name_it: "Molise",
                name_s: "MOL",
                name_nuts: "ITF2",
                data: "14"
            },
            {
                name_en: "Campania",
                name_it: "Campania",
                name_s: "CAM",
                name_nuts: "ITF3",
                data: "15"
            },
            {
                name_en: "Apulia",
                name_it: "Puglia",
                name_s: "PUG",
                name_nuts: "ITF4",
                data: "16"
            },
            {
                name_en: "Basilicate",
                name_it: "Basilicata",
                name_s: "BAS",
                name_nuts: "ITF5",
                data: "17"
            },
            {
                name_en: "Calabria",
                name_it: "Calabria",
                name_s: "CAL",
                name_nuts: "ITF6",
                data: "18"
            },
            {
                name_en: "Sicily",
                name_it: "Sicilia",
                name_s: "SIC",
                name_nuts: "ITG1",
                data: "19"
            },
            {
                name_en: "Sardinia",
                name_it: "Sardegna",
                name_s: "SAR",
                name_nuts: "ITG2",
                data: "20"
            }
        ];

        
        __checkNewRegionTimeout = null; 
        
        ixmaps.htmlgui_onZoomAndPan = function() {

            var nOpacity = (ixmaps.getZoom() - 7) / 20;
            ixmaps.setBasemapOpacity(null, nOpacity, "absolute");

            let szId = ixmaps.selectItemByPosition(null, "nuts2", ixmaps.getCenter());
            let szRegion = szId.split("::")[1];
            
            if (__checkNewRegionTimeout){
                clearTimeout(__checkNewRegionTimeout);
            }
            __checkNewRegionTimeout = setTimeout("ixmaps.__checkNewRegion('"+szRegion+"')",500);
        };
        
        ixmaps.__checkNewRegion = function(szRegion){
            console.log("checkNewRegion -----> "+szRegion);
            for (var i = 0; i < regionLookup.length; i++) {
                if ((szRegion == regionLookup[i].name_nuts) || (szRegion == regionLookup[i].name_en) || (szRegion == regionLookup[i].name_it) || (szRegion == (regionLookup[i].name_s || ""))) {
                    let szRegione = regionLookup[i].data;
                    console.log(szRegione+" != "+ixmaps.lastRegione);
                    if (szRegione != ixmaps.lastRegione) {
                        console.log("");
                        console.log("new region "+szRegione);
                        console.log("adapt themes ------>");
                        ixmaps.lastRegione = ixmaps.regione = szRegione;
                        ixmaps.map().replace("sezioni", __georef_sez2021());
                        ixmaps.map().replace("choropleth", __sez2021_pop_choropleth());
                        ixmaps.map().replace("chart_grid", __sez_2011_2021_pop_arrow_user_grid());
                        ixmaps.map().replace("chart", __sez_2011_2021_pop_arrow_user());
                        //ixmaps.map().replace("chart",__sez2021_pop_choropleth());
                        //ixmaps.map().replace("chart_grid",__sez_2011_2021_pop_arrow_user_grid());
                    }
                    break;
                }
            }
        }

        // ----------------------------------------------
        // show actual map HTML page
        // ----------------------------------------------

        var fCode = false;
        const __openSidebar = (url) => {
            const $sidebar = $("#map_code_div-project");
            $sidebar.load(url, (response, status, xhr) => {
                if (status === "error") {
                    alert(`Sorry but there was an error: ${xhr.status}\n${xhr.statusText}`);
                }
            });
        };

        __dataTheme = function() {
            if (fCode) {
                $("#map_code_div-project").html("");
                $("#map_code_div-project").hide();
            } else {
                __openSidebar('../../../pages/ISPRA/show_map_HTML.html');
                $("#map_code_div-project").show();
            }
            fCode = !fCode;
        }

    </script>

</body>

</html>
