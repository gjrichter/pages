<!DOCTYPE html>
<html>

<!-- **********************************************************************

index_only_map_embed.html

$Comment: ixmaps map template; embedded version
$Source : index_only_map_embed.html,v $

$InitialAuthor: guenter richter $
$InitialDate: 2017/06/22 $
$Author: guenter richter $
$Id:index_only_map_embed.html 1 2021-10-17 00:00:00Z Guenter Richter $

licensed under CC-BY
$Log:index_only_map_embed.html,v $

********************************************************************** -->

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="ixmaps embed example">
	<meta name="author" content="guenter richter">
	<link rel="shortcut icon" href="https://gjrichter.github.io/ixmaps/ui/resources/images/ixmaps_logo.png">

	<style>
		.button {
			font-family: monospace;
			text-decoration: none;
			border: #888 solid 1px;
			padding: 0.2em 0.55em 0.3em 0.55em;
			border-radius: 20px;
			width: 1em;
			color: #888;
		}

		.toggle .handle {
			position: relative;
			top: -20px;
			left: 0;
			display: block;
			width: 50px;
			height: 27px;
			background-color: none;
			border: #888 solid 1px;
			border-radius: 19px;
			-webkit-border-radius: 19px;
			-moz-border-radius: 19px
		}

		.toggle .handle:after,
		.toggle .handle:before {
			position: absolute;
			top: 1px;
			left: 1px;
			display: block;
			width: 23px;
			height: 23px;
			content: "";
			background-color: none;
			border: #888 solid 1px;
			border-radius: 30px;
			-webkit-transition: all .25s ease-in-out;
			-moz-transition: all .25s ease-in-out;
			transition: all .25s ease-in-out;
			-webkit-border-radius: 30px;
			-moz-border-radius: 30px
		}

		.toggle input[type=checkbox]:disabled+.handle,
		.toggle input[type=checkbox]:disabled+.handle:after,
		.toggle input[type=checkbox]:disabled+.handle:before,
		.toggle input[type=radio]:disabled+.handle,
		.toggle input[type=radio]:disabled+.handle:after,
		.toggle input[type=radio]:disabled+.handle:before {
			background-color: #e6e9ed;
			filter: alpha(opacity=60);
			opacity: .6
		}

		.toggle input[type=checkbox]:checked+.handle:before,
		.toggle input[type=radio]:checked+.handle:before {
			display: none;
			xxwidth: 50px;
			background-color: #444
		}

		.toggle input[type=checkbox]:checked+.handle:after,
		.toggle input[type=radio]:checked+.handle:after {
			background-color: #848796;
			left: 24px;
		}

		.ref {
			text-decoration: underline;
		}

		em {
			color: black;
		}

	.chart-title {
		font-size: 1.2em;
		line-height: 1em;
		font-weight: 300;
		margin-bottom: 0.2em;
		margin-top: 2em;
		border-top: #888 solid 1px;
		padding-top: 1em;
	}

	.legend-toggle {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 24px;
		height: 24px;
		background: none;
		border: none;
		cursor: pointer;
		transition: opacity 0.2s ease;
		text-decoration: none;
		opacity: 0.5;
	}

	.legend-toggle:hover {
		opacity: 1;
	}

	.legend-toggle svg {
		width: 20px;
		height: 20px;
		stroke: #888;
		fill: none;
		stroke-width: 2;
		stroke-linecap: round;
		transition: transform 0.3s ease;
	}

	.legend-toggle.collapsed svg {
		transform: rotate(180deg);
	}

	/* Sidebar Styles */
	.sidebar {
		position: fixed;
		top: 0;
		right: 0;
		width: 380px;
		height: 100vh;
		background: rgba(255, 255, 255, 0.95);
		box-shadow: -2px 0 12px rgba(0, 0, 0, 0.15);
		z-index: 9999;
		transition: transform 0.3s ease;
		overflow-y: auto;
		transform: translateX(0);
		xxborder-radius: 12px 0 0 12px;
		border: 1px solid #eee;
	}

	.sidebar-content {
		padding: 20px;
		font-size: 0.85em;
		max-width: 100%;
		overflow-x: hidden;
		overflow-y: auto;
		box-sizing: border-box;
	}

	.sidebar-content h1 {
		font-size: 1.15em !important;
		max-width: 100%;
		word-wrap: break-word;
	}

	.sidebar-content p {
		font-size: 0.95em;
		max-width: 100%;
		word-wrap: break-word;
	}

	.sidebar-content div {
		max-width: 100%;
		box-sizing: border-box;
	}

	.sidebar-content .toggle {
		max-width: 100%;
		overflow: hidden;
	}

	.sidebar-toggle {
		position: absolute;
		top: 20px;
		left: 20px;
		background: rgba(0, 0, 0, 0.1);
		border: none;
		border-radius: 8px;
		width: 40px;
		height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.2s ease;
		z-index: 10000;
	}

	.sidebar-toggle:hover {
		background: rgba(0, 0, 0, 0.2);
		transform: scale(1.1);
	}

	#sidebar_toggle {
		position: fixed;
		top: 10px;
		right: 10px;
		width: auto;
		height: auto;
		z-index: 10001;
		display: none;
	}

	#sidebar_toggle .sidebar-toggle {
		position: static;
		background: rgba(255, 255, 255, 0.95);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
		border: 1px solid rgba(0, 0, 0, 0.1);
		color: #333;
	}

	#sidebar_toggle .sidebar-toggle:hover {
		background: white;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
		transform: scale(1.1);
		color: #000;
	}

	#main_sidebar.hidden {
		transform: translateX(100%);
	}

	/* Mobile responsive */
	@media (max-width: 768px) {
		.sidebar {
			width: 100%;
			max-width: 380px;
		}

		#main_sidebar {
			transform: translateX(100%);
		}

		#main_sidebar.active {
			transform: translateX(0);
		}
	}
	</style>


</head>

<body style="max-width: 1024px;margin:auto;font-family:open sans;font-size:22px">

	<div id="map"></div>

	<!-- Sidebar toggle (pulsante per riaprire) -->
	<div id="sidebar_toggle">
		<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Apri menu">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
				<path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/>
			</svg>
		</button>
	</div>

	<!-- Sidebar principale -->
	<aside class="sidebar" id="main_sidebar">
		<div class="sidebar-content">
			<button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Chiudi menu">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
					<path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
				</svg>
			</button>
			
			<div style="position:relative;margin-top:2em">
				<header style="padding:1em 0.5em 0 0.5em;">
					<div style="display:flex;justify-content:space-between;align-items:flex-start;">
						<h1 style="margin:0 0 0.5em 0;color:#000000;font-weight:600;line-height:1.2;flex:1;"><span style="color: #380;">FUA</span> (Functional Urban Areas o <span style="color: #380;">"Aree Urbane Funzionali")</span><br>e Spostamenti giornalieri 2021</h1>
					</div>
				</header>

				<div id="legend" style="padding:0 0.5em;">
					<p style="margin:0.5em 0;">per motivi di lavoro basato su dati <b><a class="ref" href="https://www.istat.it/notizia/matrice-di-pendolarismo-per-lavoro/" target="_blank">ISTAT</a></b> riferiti al 31/12/2021</p>
					<p style="margin:0.5em 0;"><b><span style="color:#000000">archi</span></b> = spostamenti tra comuni</p>
					<p style="margin:0.5em 0;">cerchi<br>
						<b><span style="color:green">verde</span></b> = pi√π pendolari in <em>arrivo</em><br>
						<b><span style="color:red">rosso</span></b> = pi√π pendolari in <em>uscita</em><br>
						<b><span style="color:#444444">anello nero</span></b> = spostamenti <em>intra comunali</em><br>
					</p>
					
					<div style="margin-top:2em;padding:0 0.5em;">
						<div style="margin-bottom:1em;">
							<a href="javascript:ixmaps.changeThemeStyle('pendolari_flussi','maxcharts:0.5','factor')" class="button" style="pointer-events:all">-</a> 
							<span style="margin:0 0.5em;">numeri archi</span>
							<a href="javascript:ixmaps.changeThemeStyle('pendolari_flussi','maxcharts:2','factor')" class="button" style="pointer-events:all">+</a>
						</div>
						<div style="margin-bottom:1em;">
							<a href="javascript:ixmaps.changeThemeStyle('pendolari_flussi','normalsizevalue:1.25','factor')" class="button" style="pointer-events:all">-</a> 
							<span style="margin:0 0.5em;">spessore archi</span>
							<a href="javascript:ixmaps.changeThemeStyle('pendolari_flussi','normalsizevalue:0.75','factor')" class="button" style="pointer-events:all">+</a>
						</div>
					</div>
					
					<p class="checkbox" style="margin-top:0.4em;float:left;margin-bottom:-1em">
						<label class="toggle" style="margin-top:0px;float:left">
							<span style="margin:0 0.5em 0 3.5em;">saldo arrivi/partenze</span>
							<input type="checkbox" id="theme-values-checkbox" checked="checked" onchange="javascript:ixmaps.toggleTheme('pendolari_saldo')">
							<span class=" handle"></span>
						</label>
						<label class="toggle" style="margin-top:0px;float:left">
							<span style="margin:0 0.5em 0 3.5em;">spost. intra comunali</span>
							<input type="checkbox" id="theme-values-checkbox2" checked="checked" onchange="javascript:ixmaps.toggleTheme('pendolari_self')">
							<span class=" handle"></span>
						</label>
					</p>
					
					<!-- Descrizione completa -->
					<div style="clear:both;margin-top:7em;padding:1em 0.5em;border-top:1px solid #ddd;">
						<h3 style="font-size:1.1em;margin:0 0 1em 0;color:#000;">Informazioni sulla Mappa</h3>
						
						<h4 style="font-size:1em;margin:1.5em 0 0.5em 0;color:#000;font-weight:600;">Cosa sono le FUA?</h4>
						<p style="margin:0.5em 0;font-size:0.9em;line-height:1.5;">
							Le <strong>FUA (Functional Urban Areas)</strong> o "Aree Urbane Funzionali" sono zone geografiche che includono una citt√† e l'area circostante con cui ha forti legami economici e sociali. Sono definite in base ai flussi di pendolarismo giornaliero per lavoro.
						</p>
						
						<h4 style="font-size:1em;margin:1.5em 0 0.5em 0;color:#000;font-weight:600;">Dati Visualizzati</h4>
						<p style="margin:0.5em 0;font-size:0.9em;line-height:1.5;">
							Questa mappa interattiva visualizza gli <strong>spostamenti giornalieri per motivi di lavoro</strong> tra i comuni italiani, basandosi sui dati della <a href="https://www.istat.it/notizia/matrice-di-pendolarismo-per-lavoro/" target="_blank" class="ref">Matrice di Pendolarismo ISTAT</a> riferiti al <strong>31 dicembre 2021</strong>.
						</p>
						<p style="margin:0.5em 0;font-size:0.9em;line-height:1.5;">
							Il dataset analizza oltre <strong>500.000 relazioni</strong> tra comuni, mostrando dove le persone vivono e dove lavorano.
						</p>
						
						<h4 style="font-size:1em;margin:1.5em 0 0.5em 0;color:#000;font-weight:600;">Come Leggere la Mappa</h4>
						<ul style="margin:0.5em 0;padding-left:1.5em;font-size:0.9em;line-height:1.6;">
							<li style="margin:0.3em 0;"><strong>Archi (linee curve):</strong> Rappresentano i flussi di pendolari tra due comuni. Lo spessore indica il numero di persone che si spostano.</li>
							<li style="margin:0.3em 0;"><strong>Cerchi verdi:</strong> Comuni con saldo positivo (pi√π persone arrivano per lavoro di quante partono)</li>
							<li style="margin:0.3em 0;"><strong>Cerchi rossi:</strong> Comuni con saldo negativo (pi√π persone partono per lavoro di quante arrivano)</li>
							<li style="margin:0.3em 0;"><strong>Anelli neri:</strong> Rappresentano gli spostamenti intra-comunali (persone che lavorano nello stesso comune in cui risiedono)</li>
						</ul>
						
						<h4 style="font-size:1em;margin:1.5em 0 0.5em 0;color:#000;font-weight:600;">Interazione</h4>
						<ul style="margin:0.5em 0;padding-left:1.5em;font-size:0.9em;line-height:1.6;">
							<li style="margin:0.3em 0;"><strong>Zoom:</strong> Usa la rotellina del mouse o i controlli + / - per ingrandire</li>
							<li style="margin:0.3em 0;"><strong>Pan:</strong> Trascina la mappa per spostarti</li>
							<li style="margin:0.3em 0;"><strong>Click:</strong> Clicca sui comuni o sugli archi per vedere i dettagli</li>
							<li style="margin:0.3em 0;"><strong>Controlli:</strong> Usa i pulsanti +/- per regolare la visualizzazione degli archi</li>
							<li style="margin:0.3em 0;"><strong>Toggle:</strong> Attiva/disattiva i layer con le checkbox sopra</li>
						</ul>
						
						<h4 style="font-size:1em;margin:1.5em 0 0.5em 0;color:#000;font-weight:600;">Insights Chiave</h4>
						<p style="margin:0.5em 0;font-size:0.9em;line-height:1.5;">
							La mappa permette di identificare:
						</p>
						<ul style="margin:0.5em 0;padding-left:1.5em;font-size:0.9em;line-height:1.6;">
							<li style="margin:0.3em 0;">I <strong>poli di attrazione lavorativa</strong> (grandi citt√† con molti pendolari in entrata)</li>
							<li style="margin:0.3em 0;">Le <strong>citt√† dormitorio</strong> (comuni residenziali da cui partono molti lavoratori)</li>
							<li style="margin:0.3em 0;">Le <strong>connessioni pi√π forti</strong> tra aree urbane</li>
							<li style="margin:0.3em 0;">Le <strong>FUA pi√π estese</strong> e integrate</li>
						</ul>
						
						<div style="margin-top:2em;padding:1em;background:#f8f9fa;border-radius:8px;font-size:0.85em;">
							<p style="margin:0;"><strong>üìå Note:</strong></p>
							<p style="margin:0.5em 0 0 0;line-height:1.5;">
								I dati si riferiscono al <strong>31 dicembre 2021</strong>, durante il periodo pandemico, e potrebbero riflettere i cambiamenti nelle modalit√† di lavoro (smart working) emersi con la pandemia COVID-19.
							</p>
						</div>
						
						<div style="margin-top:1.5em;padding-top:1em;border-top:1px solid #ddd;font-size:0.8em;color:#666;">
							<p style="margin:0;"><strong>Fonte dati:</strong> <a href="https://www.istat.it" target="_blank" class="ref">ISTAT</a> - Istituto Nazionale di Statistica</p>
							<p style="margin:0.5em 0 0 0;"><strong>Visualizzazione:</strong> <a href="https://ixmaps.com" target="_blank" class="ref">iXMaps</a></p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</aside>
</div>
	<title>iXMaps</title>
	<!--
	<h1>di questa mappa</h1>
	-->
	<!--========================================================================= -->

	<script src="https://cdn.jsdelivr.net/gh/gjrichter/ixmaps_flat@master/ui/js/htmlgui_flat.js"></script>

	<!--========================================================================= -->

	<script type="text/javascript" charset="utf-8">
		
		ixmaps.htmlgui_onZoomAndPan = function(nZoom){
			var nOpacity = (ixmaps.getZoom() - 6) / 3;
			ixmaps.setBasemapOpacity(null, nOpacity, "absolute");
		};
		
		query_data = function(theme, options) {
			var broker = new Data.Broker()

				.addSource("https://raw.githubusercontent.com/gjrichter/data/refs/heads/master/ISTAT/pendoLAVORO/pendolari_2021_in_out_self_sum.csv", "csv")
				.addSource("https://raw.githubusercontent.com/ondata/liberiamoli-tutti/main/ries/data/comuni_dimensioni.csv", "csv")

				.realize(function(dataA) {

					var data = dataA[0];
					dataA[0].column("procom").map(function(value){
						return Number(value);
					});
					dataA[1].column("PRO_COM_T").map(function(value){
						return Number(value);
					});
					var nameLookupA = dataA[1].lookupArray({
						key: "PRO_COM_T",
						value: "istat_comune_nome"
					});
					data.addColumn({
						source: "procom",
						destination: "nome"
					}, function(value) {
						return (nameLookupA[value]);
					});
					options.type = "jsonDB", ixmaps.setExternalData(data, options);
				});
		};
		
		// ---------------------------------------------------
		// t h e   m a p   l a y e r 
		// ---------------------------------------------------

		/**
		 ** define static layer with reference shapes (comuni, province, regioni ) 
		 **/

		/* 1. centroids of 2011, by curtesy of Andrea Borruso */
		var __georef_urban =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					url: "https://raw.githubusercontent.com/aborruso/centroidiurbanfabric/master/output/ElencoUnitaAmministrative2011.geojson",
					type: "geojson"
				})
				.binding({
					id: "PRO_COM",
					position: "geometry"
				})
				.type("FEATURES|NOLEGEND")
				.style({
					colorscheme: ["none"],
					linecolor: "none",
					linewidth: "1",
					scale: "0.0001"
				})
			);

		/* 2. last istat data (2022), for changes since 2011 */
		var __georef =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					url: "https://s3.eu-central-1.amazonaws.com/maps.ixmaps.com/Istat/comuni_2022/Com01012022_s_WGS84.topojson.gz",
					type: "topojson"
				})
				.binding({
					id: "PRO_COM",
					position: "geometry"
				})
				.type("FEATURES|NOLEGEND")
				.style({
					colorscheme: ["none"],
					linecolor: "white",
					linewidth: "0.3",
					sizefield: "Shape_Area"
				})
			);


		/* 3. last istat data (2022), province */
		var __georef_prov =
			ixmaps.layer("ITALIA_Province_2022", layer => layer
				.data({
					url: "https://s3.eu-central-1.amazonaws.com/maps.ixmaps.com/Istat/province_2022/Prov01012022_g_WGS84.topojson.gz",
					type: "topojson"
				})
				.binding({
					id: "COD_PROV",
					position: "geometry"
				})
				.type("FEATURES|NOLEGEND")
				.style({
					colorscheme: ["none"],
					linecolor: "black",
					linewidth: "0.1",
					sizefield: "Shape_Area"
				})
			);

		/* 4. last istat data (2022), regioni */
		var __georef_reg =
			ixmaps.layer("ITALIA_Regioni_2022", layer => layer
				.data({
					url: "https://s3.eu-central-1.amazonaws.com/maps.ixmaps.com/Istat/regioni_2022/Reg01012022_s_WGS84.topojson.gz",
					type: "topojson"
				})
				.binding({
					id: "COD_REG",
					position: "geometry"
				})
				.type("FEATURES|NOLEGEND")
				.style({
					colorscheme: ["rgba(255,255,255,0.5)"],
					linecolor: "black",
					linewidth: "0.3",
					sizefield: "Shape_Area"
				})
			);

		const nuts2 =
            ixmaps.layer("nuts2", layer => layer
                .type("FEATURES|SILENT|LOCKED|NOLEGEND")
                .data({
                    url: "https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_10M_2021_4326_LEVL_2.geojson",
                    type: "geojson"
                })
                .binding({
                    id: "NUTS_ID"
                })
                .filter("WHERE CNTR_CODE = IT")
                .style({
                    colorscheme: [
                        "white"
                    ],
                    fillopacity: "1",
                    linecolor: "#F7F6EF",
                    linewidth: "2",
                    shadow: true,
                    showdata: true,
                    featurelower: "1:2000000",
                    titlefield: "NUTS_NAME",
                    name: "nuts2"
                })
            );

		
		// ---------------------------------------------------
		// t h e   t h e m e s  
		// ---------------------------------------------------
		
		/* arc theme */
		var __arcs =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					name: "pendolari_matrix",
					url: "https://raw.githubusercontent.com/gjrichter/data/refs/heads/master/ISTAT/pendoLAVORO/matrix_pendoLAVORO_2021.csv",
					type: "csv",
					process: function(data) {
						data.column("Procom_res").map(function(value){
							return Number(value);
						});
						data.column("Procom_lav").map(function(value){
							return Number(value);
						});
						return data;
					}
				})
				.binding({
					lookupfield: "Procom_res",
					lookupfield2: "Procom_lav",
					value: "Procom_lav"
				})
				.type("CHART|CATEGORICAL|VECTOR|BEZIER|GRADIENT|SIZE|AGGREGATE|FAST|SUM")
				.style({
					colorscheme: [
						"#000000"],
					fillopacity: 0.9,
					units: "persone",
					normalsizevalue: 8000,
					scale: 1,
					rangescale: 2,
					sizepow: 1.5,
					sizefield: "Pendolari",
					minvalue: 20,
					linecolor: [
						"#ff4444","#44dd44"],
					valuescale: 1,
					maxcharts: 10000,
					name: "pendolari_flussi"
				})
				.meta({		 
					"title": "Pendolari 2021",
					"snippet": "<b>Flusso</b> degli spostamenti casa lavoro/studi per destinazione",
					"splash":"... analizzando pi√π di 500 000 righe ...",
					tooltip: "<div style='white-space:nowrap'>{{theme.title}}<hr><h3><big>{{nome}}<br><b>{{theme.item.value}}</b></big> persone</h3></div>"
				})
			);
		
		
		/* bubble themes */
		
		var __labels =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					name: "pendolari",
					query: query_data.toString()
				})
				.binding({
					lookupfield: "procom",
					value: "self",
					title: "nome"
				})
				.type("CHART|BUBBLE|SIZE|SUM|CIRCULARBOX|BOTTOMTITLE|NOLEGEND")
				.style({
					colorscheme: [
						"none"],
					units: "persone",
					normalsizevalue: 10000,
					scale: 1,
					linecolor: [
						"none"],
					linewidth: 2,
					valuescale: 1,
					textscale: 2.5,
					boxopacity: 0.1,
					boxupper: "1:500000",
					name: "pendolari_labels"
				})
				.meta({		 
					title: "Nome comune"
				})
			);

		var __self =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					name: "pendolari",
					query: query_data.toString()
				})
				.binding({
					lookupfield: "procom",
					value: "self",
					title: "nome"
				})
				.type("CHART|BUBBLE|SIZE|SUM|CIRCULARBOX|BOTTOMTITLE|NOLEGEND")
				.style({
					colorscheme: [
						"rgba(255,255,255,0)"],
					units: "persone",
					normalsizevalue: 10000,
					scale: 1,
					linecolor: [
						"#444444"],
					linewidth: 2,
					valuescale: 1,
					textscale: 2.5,
					boxopacity: 0.1,
					boxupper: "1:500000",
					name: "pendolari_self"
				})
				.meta({		 
					title: "Pendolari <b>intra comunali</b> 2021",
					snippet: "Movimenti complessivi sul territorio del comune",
					splash: "... caricando la tabella con i spostamenti, ci sono pi√π di 500000 righe. Datemi un po' di tempo ... ",
					tooltip: "<div style='white-space:nowrap'>{{theme.title}}<hr><h3><big>{{nome}}<br><b>{{theme.item.value}}</b></big> persone</h3></div>"
				})
			);

		var __saldo =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					name: "pendolari",
					query: query_data.toString()
				})
				.binding({
					lookupfield: "procom",
					value: "saldo",
					title: "nome"
				})
				.type("CHART|BUBBLE|SIZE|FAST|NEGATIVEISVALUE|NOLEGEND")
				.style({
					colorscheme: [
						"red",
						"#33aa00"],
					rangecentervalue: 0,
					fillopacity: 0.5,
					units: "persone",
					normalsizevalue: 10000,
					scale: 1,
					linewidth: 2,
				})
				.meta({		 
					name: "pendolari_saldo",
					title: "<b>Saldo</b> pendolari 2021",
					snippet: "Saldo di entrate e uscite per motivi di lavoro o studio",
					splash: "... caricando la tabella con i spostamenti, ci sono pi√π di 500000 righe. Datemi un po' di tempo ... ",
					tooltip: "<div style='white-space:nowrap'>{{theme.title}}<hr><h3>{{nome}}<br><big><b>{{theme.item.value}}</b></big> persone</h3></div>"
				})
			);

		var __saldo_choro =
			ixmaps.layer("ITALIA_Comuni_2022", layer => layer
				.data({
					name: "pendolari",
					query: query_data.toString()
				})
				.binding({
					lookupfield: "procom",
					value: "saldo",
					value100: "inout"
				})
				.type("CHOROPLETH|QUANTILE|DOPACITYMINMAX|NOLEGEND")
				.style({
					colorscheme: [
						"7",
						"red",
						"#33aa00"],
					dopacitypow: 3,
					dopacityscale: 0.2,
					units: "persone"
				})
				.meta({		 
					name: "pendolari_saldo_choro",
					title: "Pendolari 2021",
					snippet: "Saldo di entrate e uscite per motivi di lavoro o studio",
					splash: "... caricando la tabella con i spostamenti, ci sono pi√π di 500000 righe. Datemi un po' di tempo ... "
				})
			);
			
		var __fua =
			ixmaps.layer("FUA", layer => layer
				.data({
					url: "https://raw.githubusercontent.com/gjrichter/data/master/ISTAT/FUA/fua_italia.parquet",
					type: "parquet",
					name: "fua",
					cache: "true"
					})
				.binding({
					geo: "geometry",
					value: "$item$"
					})
				.type("FEATURE")
				.style({
					colorscheme: [
						"#008800"],
					fillopacity: "0.3",
					shadow: "false",
					visible: "true",
					showdata: "true",
					units: "",
					scale: "1",
					sizepow: "2",
					linecolor: [
						"black"],
					linewidth: "0.1",
					valuescale: "1"
					})
				.meta({
					title: "FUA (Functional Urban Areas o \"Aree Urbane Funzionali\")",
					snippet: "",
					description: "",
					name: "data_1760737389569_317",
					tooltip: "{{theme.item.chart}}{{theme.item.data}}"
					})
			);

		
		var attribution = '<div style="padding:0.5em;background:rgba(255,255,255,0.2);width:70%">dati: <a class="ref" href="https://www.istat.it/it/archivio/139381" target="_blank">ISTAT</a></b> rilevati al 15¬∞ Censimento generale della popolazione (9 ottobre 2011)</div>&nbsp;&nbsp;powered by <a href="http://ixmaps.com" target="_blank">iXMaps</a></div>';

		// ----------------------------------------
		// create the map
		// ----------------------------------------

		var map = ixmaps.embed(
			"map", {
				mapService: "leaflet_vt",
				mapType: "VT_DATAVIZ",
				mode: "pan",
				tools: true,
				width: "100%",
				height: "800px",
				legend: true
			},
			(map) =>
			map
			.view({
				"center": {
					"lat": "42.069863610957555",
					"lng": "15.24128223193711"
					},
				"zoom": "6.241252622041781"
			})
			.require("https://cdn.jsdelivr.net/gh/gjrichter/ixmaps_flat@master/ui/js/tools/tooltip_mustache.js")
			.options({
				objectscaling: "dynamic", // grafici crescono leggermente con lo zoom
				seaturescaling: "true", // grafici crescono leggermente con lo zoom
				normalSizeScale: "200000", // grandezza 'normale' al livello 1:5.000.000
				dynamicScalePow: "1.8", // dynamica, 1 crescita lineare, valori > 1 meno crescita
				panhidden: "false", // grafici visibile durante lo spostamento della mappa
				basemapopacity: 0.4 // opacity of the 'leaflet' basemap
			})
			.attribution(attribution)
			.legend(" ")
			
			// -----------------------------		 
			// the geo reference layer 
			// -----------------------------

			.layer(nuts2)
			.layer(__georef_reg)
			.layer(__georef_urban)
			.layer(__georef)
			.layer(__georef_prov)
			
			// -----------------------------		 
			// the theme layer 
			// -----------------------------
			
			.layer(__fua)
			.layer(__self)
			.layer(__saldo)
			.layer(__arcs)
			.layer(__labels)
		);
        ixmaps.htmlgui_onZoomAndPan = function() { 

	var nOpacity = (ixmaps.getZoom() - 7) / 3;
		ixmaps.map().setBasemapOpacity(nOpacity, "absolute");
	}
	</script>

	<script>
		// Sidebar toggle functionality
		let sidebarOpen = true;

		function toggleSidebar() {
			const sidebar = document.getElementById('main_sidebar');
			const toggleBtn = sidebar.querySelector('.sidebar-toggle svg path');
			const externalToggle = document.getElementById('sidebar_toggle');
			sidebarOpen = !sidebarOpen;
			
			if (window.innerWidth <= 768) {
				sidebar.classList.toggle('active');
				// Su mobile, nascondi il pulsante esterno quando la sidebar √® aperta
				if (sidebar.classList.contains('active')) {
					externalToggle.style.display = 'none';
				} else {
					externalToggle.style.display = 'block';
				}
			} else {
				sidebar.classList.toggle('hidden');
				// Su desktop, mostra il pulsante esterno quando la sidebar √® nascosta
				if (sidebar.classList.contains('hidden')) {
					externalToggle.style.display = 'block';
				} else {
					externalToggle.style.display = 'none';
				}
			}
			
			// Cambia icona in base allo stato
			if (toggleBtn) {
				if (sidebarOpen) {
					// Freccia destra (chiudi) - nasconde la sidebar
					toggleBtn.setAttribute('d', 'M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z');
				} else {
					// Freccia sinistra (apri) - riporta la sidebar
					toggleBtn.setAttribute('d', 'M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z');
				}
			}
			
			// Aggiorna mappa dopo animazione
			setTimeout(() => {
				if (typeof ixmaps !== 'undefined' && ixmaps.map()) {
					ixmaps.map().resize();
				}
			}, 300);
		}

		// Gestione responsive
		window.addEventListener('resize', function() {
			const sidebar = document.getElementById('main_sidebar');
			const externalToggle = document.getElementById('sidebar_toggle');
			
			if (window.innerWidth <= 768) {
				// Mobile: nascosta di default
				sidebar.classList.remove('hidden');
				externalToggle.style.display = 'block';
				if (!sidebar.classList.contains('active')) {
					// Se non √® attiva, assicurati che sia nascosta con transform
				} else {
					externalToggle.style.display = 'none';
				}
			} else {
				// Desktop: visibile di default
				sidebar.classList.remove('active');
				if (!sidebarOpen) {
					sidebar.classList.add('hidden');
					externalToggle.style.display = 'block';
				} else {
					externalToggle.style.display = 'none';
				}
			}
		});

		// Inizializzazione
		document.addEventListener('DOMContentLoaded', function() {
			const sidebar = document.getElementById('main_sidebar');
			const externalToggle = document.getElementById('sidebar_toggle');
			
			if (window.innerWidth <= 768) {
				// Su mobile parte nascosta
				sidebarOpen = false;
				externalToggle.style.display = 'block';
			} else {
				// Su desktop parte visibile
				sidebarOpen = true;
				externalToggle.style.display = 'none';
			}
		});
	</script>
</body>

</html>
